<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MOLDERIL - Escáner de Inventario</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM CDNs for browser usage -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel CDN to compile JSX in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- jsPDF CDN for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html5-qrcode CDN for QR scanning -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans">

  <div id="root"></div>

  <!-- Main application script. Uses type="text/babel" to let Babel compile JSX -->
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;
    const { createRoot } = ReactDOM;

    // --- LOADING SCREEN COMPONENT ---
    const LoadingScreen = ({ status, progress }) => (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 font-sans">
        <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
          <h1 className="text-4xl font-extrabold text-gray-900 tracking-wide mb-6" style={{ fontFamily: 'Arial, sans-serif' }}>
            MOLDERIL
          </h1>
          <p className="text-xl text-gray-600 mb-4">{status}</p>
          <div className="w-full bg-gray-200 rounded-full h-4">
            <div
              className="bg-indigo-600 h-4 rounded-full transition-all duration-500"
              style={{ width: `${progress}%` }}
            ></div>
          </div>
        </div>
      </div>
    );

    // --- QR SCANNER COMPONENT ---
    const QrScanner = ({ onScanSuccess, onStop, onError }) => {
      const qrCodeScanner = useRef(null);
      const readerId = "reader";
      
      useEffect(() => {
        qrCodeScanner.current = new Html5Qrcode(readerId);
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };

        qrCodeScanner.current.start(
          { facingMode: "environment" },
          config,
          (decodedText) => {
            onScanSuccess(decodedText);
            onStop();
          },
          (errorMessage) => {}
        )
        .catch((err) => {
          console.error("Error al iniciar la cámara:", err);
          onError('Error: No se pudo iniciar la cámara. Asegúrate de dar los permisos necesarios.');
          onStop();
        });

        return () => {
          if (qrCodeScanner.current && qrCodeScanner.current.isScanning) {
            qrCodeScanner.current.stop().catch((err) => console.error("Error al detener la cámara:", err));
          }
        };
      }, []);

      return <div id={readerId} className="w-full max-w-sm"></div>;
    };

    // --- HELP MODAL COMPONENT ---
    const HelpModal = ({ onClose }) => (
      <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div className="relative p-6 bg-white w-full max-w-2xl rounded-xl shadow-lg m-4 max-h-[90vh] overflow-y-auto">
          <h3 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Guía de Uso</h3>
          
          <div className="space-y-4 text-gray-700">
            <div>
              <h4 className="font-semibold text-lg text-indigo-600">1. Registro Inicial</h4>
              <p>Al iniciar, la aplicación te pedirá dos datos para comenzar:</p>
              <ul className="list-disc list-inside ml-4 mt-1">
                <li><strong>Legajo de Operario:</strong> Tu número de identificación.</li>
                <li><strong>Nombre del Cliente:</strong> La empresa o persona para la que estás preparando la lista. La aplicación recordará los clientes que ingreses para sugerírtelos en el futuro.</li>
              </ul>
            </div>

            <div>
              <h4 className="font-semibold text-lg text-indigo-600">2. Escaneo de Artículos</h4>
              <p>Una vez registrado, accederás al panel de escaneo. Tienes dos formas de agregar artículos a la lista:</p>
              <ul className="list-disc list-inside ml-4 mt-1">
                <li><strong>Escanear QR:</strong> Pulsa el botón <span className="font-mono bg-purple-100 text-purple-700 rounded px-1">Escanear</span> para activar la cámara de tu dispositivo y leer los códigos QR de los bultos.</li>
                <li><strong>Ingreso Manual:</strong> Si un código no se puede leer, puedes escribir o pegar la información del QR en el campo de texto y pulsar <span className="font-mono bg-green-100 text-green-700 rounded px-1">Agregar</span>.</li>
              </ul>
              <p className="mt-2">Puedes marcar cada artículo como "Controlado" usando la casilla de verificación o eliminarlo con el ícono de la papelera.</p>
            </div>

            <div>
              <h4 className="font-semibold text-lg text-indigo-600">3. Acciones y Exportación</h4>
              <p>Cuando hayas terminado de escanear, pulsa el botón <span className="font-mono bg-blue-100 text-blue-700 rounded px-1">Acciones</span> para desplegar las opciones:</p>
              <ul className="list-disc list-inside ml-4 mt-1">
                <li><strong>Compartir:</strong> (Recomendado en móviles) Abre el menú de tu teléfono para enviar el PDF directamente a WhatsApp, Gmail, etc.</li>
                <li><strong>Descargar PDF:</strong> Guarda el archivo PDF en tu dispositivo.</li>
                <li><strong>Imprimir PDF:</strong> Abre la ventana de impresión de tu navegador.</li>
                <li><strong>Enviar por Correo/WhatsApp:</strong> Descarga el PDF y abre la aplicación correspondiente para que lo adjuntes.</li>
                <li><strong>Copiar JSON:</strong> Copia todos los datos de la lista en formato de texto (JSON) a tu portapapeles.</li>
              </ul>
            </div>
          </div>

          <div className="text-center mt-6">
            <button onClick={onClose} className="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md shadow-md hover:bg-indigo-700">
              Entendido
            </button>
          </div>
        </div>
      </div>
    );

    // --- MAIN APP COMPONENT ---
    const App = () => {
      // Loading state
      const [isLoading, setIsLoading] = useState(true);
      const [loadingStatus, setLoadingStatus] = useState('Inicializando...');
      const [loadingProgress, setLoadingProgress] = useState(0);

      // Application state
      const [items, setItems] = useState([]);
      const [operarioLegajo, setOperarioLegajo] = useState('');
      const [clienteNombre, setClienteNombre] = useState('');
      const [isDataEntered, setIsDataEntered] = useState(false);
      const [mockQrValue, setMockQrValue] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);
      const [isPdfLibLoaded, setIsPdfLibLoaded] = useState(false);
      const [isCameraActive, setIsCameraActive] = useState(false);
      const [showInfoModal, setShowInfoModal] = useState(false);
      const [showHelpModal, setShowHelpModal] = useState(false);
      const [modalContent, setModalContent] = useState({ title: '', message: '' });
      const [isActionsOpen, setIsActionsOpen] = useState(false);
      const [feedbackMessage, setFeedbackMessage] = useState('');
      const [isShareApiSupported, setIsShareApiSupported] = useState(false);
      
      // Client history state
      const [clientHistory, setClientHistory] = useState([]);
      const [showSuggestions, setShowSuggestions] = useState(false);

      const legajoInputRef = useRef(null);
      const actionsMenuRef = useRef(null);
      const clientInputRef = useRef(null);
      
      // Effect for the loading sequence and feature detection
      useEffect(() => {
        if (navigator.share) {
            setIsShareApiSupported(true);
        }

        const loadingTasks = [
          { status: "Inicializando aplicación...", duration: 500, progress: 25 },
          { status: "Cargando librerías...", duration: 800, progress: 50, action: () => setIsPdfLibLoaded(!!window.jspdf) },
          { status: "Recuperando historial...", duration: 600, progress: 75, action: () => {
              try {
                const storedClients = localStorage.getItem('molderilClientHistory');
                if (storedClients) setClientHistory(JSON.parse(storedClients));
              } catch (error) {
                console.error("Failed to load client history:", error);
              }
            }
          },
          { status: "¡Listo!", duration: 400, progress: 100 }
        ];

        let currentTask = 0;
        const runLoadingTask = () => {
          if (currentTask < loadingTasks.length) {
            const task = loadingTasks[currentTask];
            setLoadingStatus(task.status);
            setLoadingProgress(task.progress);
            if(task.action) task.action();
            
            setTimeout(() => {
              currentTask++;
              runLoadingTask();
            }, task.duration);
          } else {
            setIsLoading(false);
          }
        };

        runLoadingTask();
      }, []);


      // Effect to focus on legajo field after loading
      useEffect(() => {
        if (!isLoading && !isDataEntered && legajoInputRef.current) {
          legajoInputRef.current.focus();
        }
      }, [isLoading, isDataEntered]);
      
      // Effect to close dropdowns when clicking outside
      useEffect(() => {
        const handleClickOutside = (event) => {
          if (actionsMenuRef.current && !actionsMenuRef.current.contains(event.target)) setIsActionsOpen(false);
          if (clientInputRef.current && !clientInputRef.current.contains(event.target)) setShowSuggestions(false);
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
      }, []);

      const handleScan = (value) => {
        if (!value) return;
        const parts = value.split(';');
        if (parts.length < 7) {
          setModalContent({ title: 'Error de Formato', message: `El código QR no tiene el formato correcto (SKU;Descripcion;Lote;F.Prod;F.Venc;Cantidad;U.M.).` });
          setShowInfoModal(true);
          return;
        }
        const [sku, descripcion, lote, fechaProduccion, fechaVencimiento, cantidad, unidadMedida] = parts;
        if (items.some(item => item.sku === sku && item.lote === lote)) {
          setModalContent({ title: 'Artículo Duplicado', message: `Error: El artículo con SKU "${sku}" y Lote "${lote}" ya fue cargado.` });
          setShowInfoModal(true);
          return;
        }
        setItems([ { id: Date.now(), sku, descripcion, lote, fechaProduccion, fechaVencimiento, cantidad, unidadMedida, controlado: false }, ...items]);
        setMockQrValue('');
      };

      const handleDelete = (id) => setItems(items.filter(item => item.id !== id));
      
      const handleControlCheck = (id) => setItems(prev => prev.map(item => item.id === id ? { ...item, controlado: !item.controlado } : item));
      
      const handleKeyDown = (e) => { if (e.key === 'Enter') handleScan(mockQrValue); };

      const handleContinue = () => {
        if (operarioLegajo && clienteNombre) {
          if (!clientHistory.includes(clienteNombre.trim())) {
            const updatedHistory = [clienteNombre.trim(), ...clientHistory].slice(0, 10);
            setClientHistory(updatedHistory);
            localStorage.setItem('molderilClientHistory', JSON.stringify(updatedHistory));
          }
          setIsDataEntered(true);
          setShowSuggestions(false);
        }
      };

      const handleFormEnter = (e) => { if (e.key === 'Enter') handleContinue(); };
      
      const createPdfDocument = async () => {
        setIsGenerating(true);
        try {
          if (!isPdfLibLoaded) throw new Error("La librería jsPDF no está cargada.");
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('l', 'mm', 'a4');
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          let y = 10;
          const m = 10;
          const pageWidth = pdfWidth - (2 * m);
          const midPoint = pdfWidth / 2;

          pdf.setDrawColor(150, 150, 150);
          pdf.rect(m, y, pageWidth, 30);
          pdf.line(midPoint, y, midPoint, y + 30);

          let yLeft = y + 7;
          pdf.setFont('helvetica', 'bold');
          pdf.setFontSize(26);
          pdf.text("MOLDERIL", m + 5, yLeft);
          pdf.setFont('helvetica', 'normal');
          pdf.setFontSize(8);
          yLeft += 8;
          pdf.text("ADMINISTRACION Y VENTAS:", m + 5, yLeft);
          yLeft += 4;
          pdf.text("AV. Hermanos Lescano 550 - Rio Primero (Cordoba)", m + 5, yLeft);
          yLeft += 4;
          pdf.text("Tel/Fax: 03574-420768 (lineas Rotativas)", m + 5, yLeft);

          let yRight = y + 7;
          pdf.setFont('helvetica', 'bold');
          pdf.setFontSize(14);
          pdf.text("LISTA DE EMPAQUE", midPoint + 5, yRight);
          pdf.line(midPoint + 5, yRight + 1, midPoint + 60, yRight + 1);

          pdf.setFont('helvetica', 'normal');
          pdf.setFontSize(9);
          yRight += 8;
          pdf.text(`Cliente:`, midPoint + 5, yRight);
          pdf.setFont('helvetica', 'bold');
          pdf.text(`${clienteNombre || 'N/A'}`, midPoint + 20, yRight);
          pdf.setFont('helvetica', 'normal');
          yRight += 5;
          pdf.text(`Operario (Legajo):`, midPoint + 5, yRight);
          pdf.setFont('helvetica', 'bold');
          pdf.text(`${operarioLegajo || 'N/A'}`, midPoint + 33, yRight);
          pdf.setFont('helvetica', 'normal');
          yRight += 5;
          pdf.text(`Fecha y Hora:`, midPoint + 5, yRight);
          pdf.setFont('helvetica', 'bold');
          pdf.text(`${new Date().toLocaleString()}`, midPoint + 26, yRight);
          
          y = 45;
          const headers = ["SKU", "Descripción", "Lote", "F. Prod.", "F. Venc.", "Cant.", "U.M.", "Control"];
          const colWidths = [0.12, 0.33, 0.15, 0.1, 0.1, 0.06, 0.05, 0.09];
          const colPos = colWidths.reduce((acc, width, i) => {
              acc.push( (i === 0 ? m : acc[i - 1]) + (i === 0 ? 0 : pageWidth * colWidths[i - 1]) );
              return acc;
          }, []);
          
          const drawHeader = (currentY) => {
              pdf.setFont('helvetica', 'bold');
              pdf.setFontSize(7);
              pdf.setFillColor(230, 230, 230);
              pdf.rect(m, currentY, pageWidth, 6, 'F');
              headers.forEach((h, i) => pdf.text(h, colPos[i] + 2, currentY + 4));
              return currentY + 6;
          };
          y = drawHeader(y);
          
          const rowHeight = 5;
          const startTableY = y;
          pdf.setFont('helvetica', 'normal');
          pdf.setFontSize(7);

          items.forEach((item) => {
            if (y + rowHeight > pdfHeight - m - 15) {
              pdf.addPage();
              y = m;
              y = drawHeader(y);
              pdf.setFontSize(7);
            }
            pdf.line(m, y, pdfWidth - m, y);
            const itemData = [item.sku, item.descripcion, item.lote, item.fechaProduccion, item.fechaVencimiento, item.cantidad, item.unidadMedida].map(d => String(d || ''));
            itemData.forEach((data, i) => pdf.text(data, colPos[i] + 2, y + 3.5));
            const boxSize = 3;
            pdf.rect(colPos[7] + (pageWidth * colWidths[7] / 2) - (boxSize / 2), y + (rowHeight / 2) - (boxSize / 2), boxSize, boxSize);
            y += rowHeight;
          });
          
          pdf.line(m, y, pdfWidth - m, y);
          colPos.forEach(pos => pdf.line(pos, startTableY, pos, y));
          pdf.line(pdfWidth - m, startTableY, pdfWidth - m, y);

          y += 8;
          pdf.setFont('helvetica', 'bold');
          pdf.setFontSize(12);
          pdf.text(`Total de bultos escaneados: ${items.length}`, m, y);
          
          y = pdfHeight - 20;
          pdf.setFontSize(10);
          pdf.text("Responsable de Carga:", m, y);
          pdf.line(m + 45, y, m + 125, y);
          y += 5;
          pdf.setFontSize(8);
          pdf.text("Firma y Aclaración", m + 65, y);

          return pdf;
        } catch (error) {
          console.error("Error al crear el documento PDF:", error);
          setModalContent({ title: 'Error de PDF', message: `Error: ${error.message}` });
          setShowInfoModal(true);
          return null;
        } finally {
          setIsGenerating(false);
          setIsActionsOpen(false);
        }
      };

      const showFeedback = (message) => {
        setFeedbackMessage(message);
        setTimeout(() => setFeedbackMessage(''), 2000);
      };

      const getPdfFilename = () => {
        const date = new Date();
        const dateString = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
        const timeString = `${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}`;
        return `Lista_Empaque_${dateString}-${timeString}_${operarioLegajo}.pdf`;
      }

      const handleDownloadPdf = async () => { 
        const pdf = await createPdfDocument(); 
        if (pdf) { 
          pdf.save(getPdfFilename()); 
          showFeedback('PDF descargado.'); 
        } 
      };
      
      const handlePrintPdf = async () => { 
        const pdf = await createPdfDocument(); 
        if (pdf) {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = pdf.output('bloburl');
            document.body.appendChild(iframe);
            iframe.contentWindow.print();
        }
      };
      
      const handleEmailPdf = async () => {
        const pdf = await createPdfDocument();
        if (pdf) {
            const pdfName = getPdfFilename();
            pdf.save(pdfName);
            const mailtoLink = `mailto:?subject=${encodeURIComponent(`Lista de Empaque - Cliente: ${clienteNombre || 'N/A'}`)}&body=${encodeURIComponent(`Hola,\n\nEl archivo "${pdfName}" se ha descargado. Por favor, adjúntalo a este correo.\n\nGenerado por MOLDERIL Inventory Scanner.`)}`;
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            iframe.src = mailtoLink;
            setTimeout(() => {
                document.body.removeChild(iframe);
            }, 500);
        }
      };

      const handleWhatsAppPdf = async () => {
        const pdf = await createPdfDocument();
        if (pdf) {
            const pdfName = getPdfFilename();
            pdf.save(pdfName);
            setModalContent({ title: 'Enviar por WhatsApp', message: `El archivo "${pdfName}" se ha descargado. Ahora se abrirá WhatsApp Web para que lo adjuntes.` });
            setShowInfoModal(true);
            window.open('https://web.whatsapp.com/', '_blank');
        }
      };

      const handleShare = async () => {
        const pdf = await createPdfDocument();
        if (!pdf) return;

        const pdfBlob = pdf.output('blob');
        const pdfFile = new File([pdfBlob], getPdfFilename(), { type: 'application/pdf' });
        const shareData = {
            files: [pdfFile],
            title: `Lista de Empaque - ${clienteNombre}`,
            text: `Lista de empaque generada para el cliente ${clienteNombre}.`,
        };

        if (navigator.canShare && navigator.canShare(shareData)) {
            try {
                await navigator.share(shareData);
                showFeedback('¡Contenido compartido!');
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error al compartir:', error);
                    setModalContent({ title: 'Error al Compartir', message: `Ocurrió un error: ${error.message}` });
                    setShowInfoModal(true);
                }
            }
        } else {
            setModalContent({ title: 'No se puede compartir', message: `Tu navegador no soporta compartir este tipo de archivo. Por favor, descarga el PDF y compártelo manualmente.` });
            setShowInfoModal(true);
        }
      };

      const handleCopyJson = () => {
        setIsActionsOpen(false);
        const jsonString = JSON.stringify(items.map(({ id, controlado, ...rest }) => rest), null, 2);

        // Fallback for copying to clipboard
        const copyToClipboard = (text) => {
          if (navigator.clipboard && window.isSecureContext) {
            return navigator.clipboard.writeText(text);
          } else {
            // Fallback for insecure contexts or older browsers
            let textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            return new Promise((res, rej) => {
              document.execCommand('copy') ? res() : rej();
              textArea.remove();
            });
          }
        };

        copyToClipboard(jsonString)
          .then(() => showFeedback('¡JSON copiado!'))
          .catch(() => {
            setModalContent({ title: 'Error', message: 'No se pudo copiar el contenido JSON.' });
            setShowInfoModal(true);
          });
      };

      const handleReset = () => { setIsDataEntered(false); setOperarioLegajo(''); setClienteNombre(''); setItems([]); };
      
      const InfoModal = ({ onClose, title, message }) => (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
          <div className="relative p-8 bg-white w-full max-w-lg rounded-xl shadow-lg m-4">
            <h3 className={`text-2xl font-bold ${title.toLowerCase().includes('error') ? 'text-red-600' : 'text-blue-600'} mb-4`}>{title}</h3>
            <p className="text-xl text-gray-700 mb-4 whitespace-pre-wrap">{message}</p>
            <div className="text-center">
              <button onClick={onClose} className="bg-blue-600 text-white font-semibold py-3 px-6 rounded-md shadow-md hover:bg-blue-700">Entendido</button>
            </div>
          </div>
        </div>
      );
      
      if (isLoading) {
        return <LoadingScreen status={loadingStatus} progress={loadingProgress} />;
      }

      if (!isDataEntered) {
        const filteredSuggestions = clientHistory.filter(client => clienteNombre && client.toLowerCase().includes(clienteNombre.toLowerCase()));
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
            {showInfoModal && <InfoModal onClose={() => setShowInfoModal(false)} title={modalContent.title} message={modalContent.message} />}
            {showHelpModal && <HelpModal onClose={() => setShowHelpModal(false)} />}
            <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md relative">
              <button onClick={() => setShowHelpModal(true)} title="Ayuda" className="absolute top-4 right-4 text-gray-400 hover:text-indigo-600 transition-colors">
                  <i className="fas fa-question-circle text-2xl"></i>
              </button>
              <h1 className="text-4xl font-extrabold text-center text-gray-900 mb-6">MOLDERIL</h1>
              <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">Lista de Empaque</h2>
              <div className="space-y-4">
                <div>
                  <label htmlFor="legajo" className="block text-xl font-medium text-gray-700">Legajo</label>
                  <input type="number" id="legajo" ref={legajoInputRef} value={operarioLegajo} onChange={(e) => setOperarioLegajo(e.target.value)} onKeyDown={handleFormEnter} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border text-2xl" placeholder="Ej: 12345"/>
                </div>
                <div className="relative" ref={clientInputRef}>
                  <label htmlFor="cliente" className="block text-xl font-medium text-gray-700">Cliente</label>
                  <input type="text" id="cliente" value={clienteNombre} onChange={(e) => { setClienteNombre(e.target.value); setShowSuggestions(true); }} onKeyDown={handleFormEnter} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border text-2xl" placeholder="Ej: Empresa ABC" autoComplete="off"/>
                  {showSuggestions && filteredSuggestions.length > 0 && (
                    <ul className="absolute z-10 w-full bg-white border rounded-md mt-1 max-h-40 overflow-y-auto shadow-lg">
                      {filteredSuggestions.map(client => (
                        <li key={client} className="p-2 hover:bg-indigo-100 cursor-pointer text-xl" onClick={() => { setClienteNombre(client); setShowSuggestions(false); }}>
                          {client}
                        </li>
                      ))}
                    </ul>
                  )}
                </div>
                <button onClick={handleContinue} disabled={!operarioLegajo || !clienteNombre} className="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-md shadow-md hover:bg-indigo-700 disabled:opacity-50 text-xl">
                  Continuar
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-100 p-4 flex flex-col">
          {showInfoModal && <InfoModal onClose={() => setShowInfoModal(false)} title={modalContent.title} message={modalContent.message} />}
          {showHelpModal && <HelpModal onClose={() => setShowHelpModal(false)} />}
          {feedbackMessage && <div className="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50">{feedbackMessage}</div>}
          <div className="bg-white p-6 rounded-xl shadow-lg flex-grow">
            
            <div className="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6 shadow-sm">
              <div className="flex justify-between items-center">
                <div>
                  <h1 className="text-3xl font-extrabold text-gray-900">MOLDERIL</h1>
                  <p className="text-xs text-gray-500 mt-1">AV. Hermanos Lescano 550 - Rio Primero (Cordoba)</p>
                  <p className="text-xs text-gray-500">Tel/Fax: 03574-420768</p>
                </div>
                <div className="flex items-center space-x-4">
                    <div className="text-right space-y-2">
                      <div className="flex items-center justify-end">
                        <div className="text-right mr-3">
                          <p className="text-xs text-gray-500">Operario (Legajo)</p>
                          <p className="font-semibold text-gray-800 text-lg">{operarioLegajo}</p>
                        </div>
                        <i className="fas fa-user-circle text-gray-400 text-2xl"></i>
                      </div>
                      <div className="flex items-center justify-end">
                         <div className="text-right mr-3">
                          <p className="text-xs text-gray-500">Cliente</p>
                          <p className="font-semibold text-gray-800 text-lg">{clienteNombre}</p>
                        </div>
                        <i className="fas fa-building text-gray-400 text-2xl"></i>
                      </div>
                    </div>
                    <button onClick={() => setShowHelpModal(true)} title="Ayuda" className="text-gray-400 hover:text-indigo-600 transition-colors self-start">
                        <i className="fas fa-question-circle text-2xl"></i>
                    </button>
                </div>
              </div>
            </div>

            {isCameraActive ? (
              <div className="flex flex-col items-center space-y-4">
                <QrScanner onScanSuccess={handleScan} onStop={() => setIsCameraActive(false)} onError={(msg) => { setModalContent({ title: 'Error de Cámara', message: msg }); setShowInfoModal(true); }} />
                <button onClick={() => setIsCameraActive(false)} className="w-full max-w-sm bg-red-600 text-white font-semibold py-3 px-4 rounded-md shadow-md hover:bg-red-700 text-xl">
                  Cancelar Escaneo
                </button>
              </div>
            ) : (
              <>
                <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                  <input type="text" value={mockQrValue} onChange={(e) => setMockQrValue(e.target.value)} onKeyDown={handleKeyDown} className="flex-grow rounded-md p-2 border text-xl" placeholder="Simular escaneo QR o pegar valor"/>
                  <button onClick={() => handleScan(mockQrValue)} disabled={!mockQrValue} className="bg-green-600 text-white font-semibold py-3 px-4 rounded-md shadow-md hover:bg-green-700 disabled:opacity-50 text-xl">
                    Agregar
                  </button>
                  <button onClick={() => setIsCameraActive(true)} className="bg-purple-600 text-white font-semibold py-3 px-4 rounded-md shadow-md hover:bg-purple-700 text-xl flex items-center justify-center">
                    <i className="fas fa-camera mr-2"></i> Escanear
                  </button>
                </div>

                <div className="overflow-x-auto rounded-lg shadow-md mb-6 border">
                  <table className="min-w-full divide-y divide-gray-200 table-auto">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">SKU</th>
                        <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descripción</th>
                        <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lote</th>
                        <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">F. Prod</th>
                        <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">F. Venc</th>
                        <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cant.</th>
                        <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">U.M.</th>
                        <th className="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase">Control</th>
                        <th className="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase">Acción</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {items.length === 0 ? (
                        <tr><td colSpan="9" className="px-2 py-4 text-center text-sm text-gray-500 italic">Aún no hay registros.</td></tr>
                      ) : (
                        items.map((item) => (
                          <tr key={item.id} className="hover:bg-gray-50">
                            <td className="px-2 py-4 whitespace-nowrap text-sm">{item.sku}</td>
                            <td className="px-2 py-4 whitespace-nowrap text-sm">{item.descripcion}</td>
                            <td className="px-2 py-4 whitespace-nowrap text-sm">{item.lote}</td>
                            <td className="px-2 py-4 whitespace-nowrap text-sm">{item.fechaProduccion}</td>
                            <td className="px-2 py-4 whitespace-nowrap text-sm">{item.fechaVencimiento}</td>
                            <td className="px-2 py-4 whitespace-nowrap text-sm">{item.cantidad}</td>
                            <td className="px-2 py-4 whitespace-nowrap text-sm">{item.unidadMedida}</td>
                            <td className="px-2 py-4 text-center"><input type="checkbox" checked={item.controlado} onChange={() => handleControlCheck(item.id)} className="h-4 w-4"/></td>
                            <td className="px-2 py-4 text-center"><button onClick={() => handleDelete(item.id)} className="text-red-600 hover:text-red-900"><i className="fas fa-trash"></i></button></td>
                          </tr>
                        ))
                      )}
                      <tr className="bg-gray-100 font-bold">
                        <td colSpan="8" className="px-2 py-4 text-right text-sm">Total de bultos:</td>
                        <td className="px-2 py-4 text-sm">{items.length}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                  <div className="relative w-full sm:w-auto flex-grow" ref={actionsMenuRef}>
                    <button onClick={() => setIsActionsOpen(prev => !prev)} disabled={items.length === 0 || isGenerating || !isPdfLibLoaded} className="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-md shadow-md hover:bg-blue-700 disabled:opacity-50 text-xl flex items-center justify-center">
                      {isGenerating ? `Generando...` : 'Acciones'} <i className={`fas fa-chevron-down ml-2 transition-transform ${isActionsOpen ? 'rotate-180' : ''}`}></i>
                    </button>
                    {isActionsOpen && (
                      <div className="absolute bottom-full mb-2 w-full bg-white rounded-md shadow-lg border z-20">
                        <ul className="text-gray-700">
                          {isShareApiSupported && (
                            <>
                              <li><button onClick={handleShare} className="w-full text-left font-bold text-indigo-600 hover:bg-indigo-50 p-3 flex items-center"><i className="fas fa-share-alt w-6 mr-2"></i>Compartir</button></li>
                              <li><hr className="my-1"/></li>
                            </>
                          )}
                          <li><button onClick={handleDownloadPdf} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-download w-6 mr-2"></i>Descargar PDF</button></li>
                          <li><button onClick={handlePrintPdf} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-print w-6 mr-2"></i>Imprimir PDF</button></li>
                          <li><button onClick={handleEmailPdf} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-envelope w-6 mr-2"></i>Enviar por Correo</button></li>
                          <li><button onClick={handleWhatsAppPdf} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fab fa-whatsapp w-6 mr-2"></i>Enviar por WhatsApp</button></li>
                           <li><hr className="my-1"/></li>
                          <li><button onClick={handleCopyJson} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-copy w-6 mr-2"></i>Copiar JSON</button></li>
                        </ul>
                      </div>
                    )}
                  </div>
                  <button onClick={handleReset} className="w-full sm:w-auto flex-grow bg-gray-600 text-white font-semibold py-3 px-4 rounded-md shadow-md hover:bg-gray-700 text-xl">
                    Nuevo Escaneo
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
