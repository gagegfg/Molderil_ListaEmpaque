<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MOLDERIL - Sistema de Gestión</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM CDNs for browser usage -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel CDN to compile JSX in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- jsPDF CDN for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html5-qrcode CDN for QR scanning -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- qrcode.js for QR generation -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    @media print {
      body * {
        visibility: hidden;
      }
      #printable-label, #printable-label * {
        visibility: visible;
      }
      #printable-label {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">

  <div id="root"></div>
  <div id="reader-placeholder" style="display: none;"></div>

  <!-- Main application script -->
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;
    const { createRoot } = ReactDOM;

    // --- SHARED COMPONENTS ---
    const HelpModal = ({ content, onClose }) => (
      <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div className="relative p-6 bg-white w-full max-w-2xl rounded-xl shadow-lg m-4 max-h-[90vh] overflow-y-auto">
          <h3 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Guía de Uso</h3>
          {content}
          <div className="text-center mt-6">
            <button onClick={onClose} className="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md shadow-md hover:bg-indigo-700">
              Entendido
            </button>
          </div>
        </div>
      </div>
    );
    
    // --- QR LABEL GENERATOR (PROCESS 1) ---
    const QrGenerator = ({ onBackToMenu }) => {
        const [operario, setOperario] = useState('');
        const [articulos, setArticulos] = useState([]);
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedArticulo, setSelectedArticulo] = useState(null);
        const [fechaProd, setFechaProd] = useState(new Date().toISOString().split('T')[0]);
        const [fechaVenc, setFechaVenc] = useState('');
        const [cantidad, setCantidad] = useState('');
        const [uom, setUom] = useState('Unidad');
        const [generatedData, setGeneratedData] = useState(null);

        const qrCodeRef = useRef(null);

        // Load articles from CSV
        useEffect(() => {
            const fetchArticulos = async () => {
                try {
                    const response = await fetch('articulos.csv');
                    const text = await response.text();
                    const rows = text.split('\n').slice(1); // Skip header
                    const parsedArticulos = rows.map(row => {
                        const [tipo_articulo, codigo_articulo, descripcion] = row.split(';'); // Use semicolon
                        return { tipo: tipo_articulo, sku: codigo_articulo, descripcion: descripcion?.trim() };
                    }).filter(art => art.sku && art.descripcion);
                    setArticulos(parsedArticulos);
                } catch (error) {
                    console.error("Error loading articulos.csv:", error);
                }
            };
            fetchArticulos();
        }, []);

        // Update expiration date when production date changes
        useEffect(() => {
            if (fechaProd) {
                const prodDate = new Date(fechaProd);
                prodDate.setFullYear(prodDate.getFullYear() + 3);
                setFechaVenc(prodDate.toISOString().split('T')[0]);
            }
        }, [fechaProd]);

        // Generate QR code when data is ready
        useEffect(() => {
            if (generatedData && qrCodeRef.current) {
                QRCode.toCanvas(qrCodeRef.current, JSON.stringify(generatedData), { width: 200 }, (error) => {
                    if (error) console.error(error);
                });
            }
        }, [generatedData]);

        const filteredArticulos = searchTerm
            ? articulos.filter(art =>
                art.sku.toLowerCase().includes(searchTerm.toLowerCase()) ||
                art.descripcion.toLowerCase().includes(searchTerm.toLowerCase())
            )
            : [];

        const handleGenerateLabel = () => {
            if (!operario || !selectedArticulo || !cantidad || !uom || !fechaProd || !fechaVenc) {
                alert("Por favor, complete todos los campos.");
                return;
            }
            const palletId = `PALLET-${new Date().toISOString().replace(/[-:.]/g, '').slice(0, 14)}-${operario}`;
            const data = {
                palletId,
                sku: selectedArticulo.sku,
                descripcion: selectedArticulo.descripcion,
                cantidad: parseFloat(cantidad),
                uom,
                fechaProd,
                fechaVenc,
                operario
            };
            setGeneratedData(data);
        };
        
        const handlePrint = () => {
            window.print();
        };

        return (
            <div className="min-h-screen bg-gray-100 p-4 flex flex-col">
                <div className="bg-white p-6 rounded-xl shadow-lg flex-grow">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-3xl font-extrabold text-gray-900">Generar Etiqueta de Pallet</h1>
                        <button onClick={onBackToMenu} className="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Volver al Menú</button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Form Column */}
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Operario</label>
                                <input type="text" value={operario} onChange={e => setOperario(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" />
                            </div>
                            <div className="relative">
                                <label className="block text-sm font-medium text-gray-700">Artículo (Buscar por SKU o Descripción)</label>
                                <input type="text" value={searchTerm} onChange={e => { setSearchTerm(e.target.value); setSelectedArticulo(null); }} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" />
                                {searchTerm && (
                                    <ul className="absolute z-10 w-full bg-white border rounded-md mt-1 max-h-40 overflow-y-auto shadow-lg">
                                        {filteredArticulos.map(art => (
                                            <li key={art.sku} className="p-2 hover:bg-indigo-100 cursor-pointer" onClick={() => { setSelectedArticulo(art); setSearchTerm(`${art.sku} - ${art.descripcion}`); }}>
                                                {art.sku} - {art.descripcion}
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Fecha de Producción</label>
                                <input type="date" value={fechaProd} onChange={e => setFechaProd(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Fecha de Vencimiento</label>
                                <input type="date" value={fechaVenc} readOnly className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-gray-100" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Cantidad</label>
                                <input type="number" value={cantidad} onChange={e => setCantidad(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Unidad de Medida</label>
                                <select value={uom} onChange={e => setUom(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                    <option>Unidad</option>
                                    <option>Millar</option>
                                </select>
                            </div>
                            <button onClick={handleGenerateLabel} className="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-md shadow-md hover:bg-blue-700 text-xl">
                                Generar Etiqueta
                            </button>
                        </div>

                        {/* Preview Column */}
                        <div>
                            <h3 className="text-lg font-medium text-gray-900 mb-2">Vista Previa de Etiqueta</h3>
                            <div id="printable-label" className="border-2 border-dashed border-gray-400 p-4 rounded-lg bg-white">
                                {generatedData ? (
                                    <div className="flex space-x-4">
                                        <div className="flex-shrink-0">
                                            <canvas ref={qrCodeRef}></canvas>
                                        </div>
                                        <div className="text-sm space-y-1">
                                            <p><strong>Artículo:</strong> {generatedData.descripcion}</p>
                                            <p><strong>SKU:</strong> {generatedData.sku}</p>
                                            <p><strong>Cantidad:</strong> {generatedData.cantidad} {generatedData.uom}</p>
                                            <p><strong>Fecha Prod:</strong> {new Date(generatedData.fechaProd + 'T00:00:00').toLocaleDateString('es-ES')}</p>
                                            <p><strong>Fecha Venc:</strong> {new Date(generatedData.fechaVenc + 'T00:00:00').toLocaleDateString('es-ES')}</p>
                                            <p className="text-xs text-gray-500 pt-2"><strong>ID Pallet:</strong> {generatedData.palletId}</p>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center text-gray-500 py-16">
                                        Complete el formulario para ver la etiqueta
                                    </div>
                                )}
                            </div>
                            {generatedData && (
                                <button onClick={handlePrint} className="w-full mt-4 bg-green-600 text-white font-semibold py-3 px-4 rounded-md shadow-md hover:bg-green-700 text-xl">
                                    Imprimir
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    // --- PACKING LIST SCANNER (PROCESS 2) ---
    const PackingListScanner = ({ onBackToMenu }) => {
        const [items, setItems] = useState([]);
        const [operarioLegajo, setOperarioLegajo] = useState('');
        const [clienteNombre, setClienteNombre] = useState('');
        const [isDataEntered, setIsDataEntered] = useState(false);
        const [mockQrValue, setMockQrValue] = useState('');
        const [isGenerating, setIsGenerating] = useState(false);
        const [isPdfLibLoaded, setIsPdfLibLoaded] = useState(false);
        const [isCameraActive, setIsCameraActive] = useState(false);
        const [showInfoModal, setShowInfoModal] = useState(false);
        const [showHelpModal, setShowHelpModal] = useState(false);
        const [modalContent, setModalContent] = useState({ title: '', message: '' });
        const [isActionsOpen, setIsActionsOpen] = useState(false);
        const [feedbackMessage, setFeedbackMessage] = useState('');
        const [isShareApiSupported, setIsShareApiSupported] = useState(false);
        const [clientList, setClientList] = useState([]);
        const [showSuggestions, setShowSuggestions] = useState(false);

        const legajoInputRef = useRef(null);
        const actionsMenuRef = useRef(null);
        const clientInputRef = useRef(null);
        const fileInputRef = useRef(null);
        const manualInputRef = useRef(null);

        useEffect(() => {
            if (navigator.share) setIsShareApiSupported(true);
            setIsPdfLibLoaded(!!window.jspdf);
            const fetchClients = async () => {
                try {
                    const response = await fetch('clientes.txt');
                    const text = await response.text();
                    const clients = text.split('\n').map(client => client.trim().toUpperCase()).filter(Boolean);
                    setClientList(clients);
                } catch (error) {
                    console.error("Failed to load client list:", error);
                }
            };
            fetchClients();
        }, []);

        useEffect(() => {
            if (!isDataEntered && legajoInputRef.current) {
                legajoInputRef.current.focus();
            } else if (isDataEntered && manualInputRef.current) {
                setTimeout(() => manualInputRef.current.focus(), 100);
            }
        }, [isDataEntered]);
        
        const validateQrData = (parts) => {
          if (parts.length < 7) return "El código QR no tiene los 7 campos requeridos.";
          const [, , , fechaProduccion, fechaVencimiento, cantidad] = parts;
          const parseDate = (dateStr) => {
              if (typeof dateStr !== 'string') return null;
              const parts = dateStr.match(/(\d+)/g);
              if (!parts || parts.length < 3) return null;
              let day, month, year;
              if (parts[2].length === 4) {
                  day = parseInt(parts[0], 10);
                  month = parseInt(parts[1], 10) - 1;
                  year = parseInt(parts[2], 10);
              } else {
                  day = parseInt(parts[2], 10);
                  month = parseInt(parts[1], 10) - 1;
                  year = parseInt(parts[0], 10);
              }
              const date = new Date(year, month, day);
              if (isNaN(date.getTime()) || date.getFullYear() !== year || date.getMonth() !== month || date.getDate() !== day) return null;
              return date;
          };
          if (!parseDate(fechaProduccion) || !parseDate(fechaVencimiento)) return "Una o ambas fechas no tienen un formato válido.";
          const parseSpanishNumber = (str) => {
              if (typeof str !== 'string') return NaN;
              return parseFloat(str.replace(/\./g, '').replace(',', '.'));
          };
          if (isNaN(parseSpanishNumber(cantidad))) return "La cantidad debe ser un valor numérico.";
          return null;
      };

      const handleScan = (value) => {
        if (!value) return;
        const parts = value.split(';');
        const validationError = validateQrData(parts);
        if (validationError) {
            setModalContent({ title: 'Error en Datos de QR', message: validationError });
            setShowInfoModal(true);
            return;
        }
        const [sku, descripcion, lote, fechaProduccion, fechaVencimiento, cantidad, unidadMedida] = parts;
        if (items.some(item => item.sku === sku && item.lote === lote)) {
          setModalContent({ title: 'Artículo Duplicado', message: `Error: El artículo con SKU "${sku}" y Lote "${lote}" ya fue cargado.` });
          setShowInfoModal(true);
          return;
        }
        const formatDate = (dateObj) => {
          if (!(dateObj instanceof Date)) return '';
          const day = String(dateObj.getDate()).padStart(2, '0');
          const month = String(dateObj.getMonth() + 1).padStart(2, '0');
          const year = dateObj.getFullYear();
          return `${day}/${month}/${year}`;
        };
        const formatSpanishNumber = (num) => {
          if (isNaN(num)) return '';
          return new Intl.NumberFormat('es-ES').format(num);
        };
        const parseDate = (dateStr) => {
          if (typeof dateStr !== 'string') return null;
          const parts = dateStr.match(/(\d+)/g);
          if (!parts || parts.length < 3) return null;
          let day, month, year;
          if (parts[2].length === 4) {
              day = parseInt(parts[0], 10);
              month = parseInt(parts[1], 10) - 1;
              year = parseInt(parts[2], 10);
          } else {
              day = parseInt(parts[2], 10);
              month = parseInt(parts[1], 10) - 1;
              year = parseInt(parts[0], 10);
          }
          const date = new Date(year, month, day);
          if (isNaN(date.getTime()) || date.getFullYear() !== year || date.getMonth() !== month || date.getDate() !== day) return null;
          return date;
        };
        const parseSpanishNumber = (str) => {
          if (typeof str !== 'string') return NaN;
          return parseFloat(str.replace(/\./g, '').replace(',', '.'));
        };

        const newItem = { 
            id: Date.now(), 
            sku, 
            descripcion, 
            lote, 
            fechaProduccion: formatDate(parseDate(fechaProduccion)),
            fechaVencimiento: formatDate(parseDate(fechaVencimiento)),
            cantidad: formatSpanishNumber(parseSpanishNumber(cantidad)),
            unidadMedida, 
            controlado: false 
        };
        setItems([newItem, ...items]);
        setMockQrValue('');
        setTimeout(() => manualInputRef.current?.focus(), 0);
      };

      const handleDelete = (id) => setItems(items.filter(item => item.id !== id));
      const handleControlCheck = (id) => setItems(prev => prev.map(item => item.id === id ? { ...item, controlado: !item.controlado } : item));
      const handleKeyDown = (e) => { if (e.key === 'Enter') handleScan(mockQrValue); };
      const handleContinue = () => {
        if (operarioLegajo && clienteNombre) {
          const formattedLegajo = parseInt(operarioLegajo, 10).toString();
          setOperarioLegajo(formattedLegajo);
          setIsDataEntered(true);
          setShowSuggestions(false);
        }
      };
      const handleFormEnter = (e) => { if (e.key === 'Enter') handleContinue(); };
      const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const html5QrCode = new Html5Qrcode("reader-placeholder");
        html5QrCode.scanFile(file, true)
        .then(decodedText => {
            handleScan(decodedText);
        })
        .catch(err => {
            console.error(`Error scanning file. Reason: ${err}`);
            setModalContent({ title: 'Error de Escaneo', message: 'No se pudo encontrar un código QR en la imagen. Intenta con una imagen más clara o mejor recortada.' });
            setShowInfoModal(true);
        });
        e.target.value = '';
      };
      const createPdfDocument = async () => {
        setIsGenerating(true);
        try {
          if (!isPdfLibLoaded) throw new Error("La librería jsPDF no está cargada.");
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('l', 'mm', 'a4');
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          let y = 10;
          const m = 10;
          const pageWidth = pdfWidth - (2 * m);
          const midPoint = pdfWidth / 2;
          pdf.setDrawColor(150, 150, 150);
          pdf.rect(m, y, pageWidth, 30);
          pdf.line(midPoint, y, midPoint, y + 30);
          let yLeft = y + 7;
          pdf.setFont('helvetica', 'bold');
          pdf.setFontSize(26);
          pdf.text("MOLDERIL S.A.", m + 5, yLeft);
          pdf.setFont('helvetica', 'normal');
          pdf.setFontSize(8);
          yLeft += 8;
          pdf.text("ADMINISTRACION Y VENTAS:", m + 5, yLeft);
          yLeft += 4;
          pdf.text("AV. Hermanos Lescano 550 - Rio Primero (Cordoba)", m + 5, yLeft);
          yLeft += 4;
          pdf.text("Tel/Fax: 03574-420768 (lineas Rotativas)", m + 5, yLeft);
          let yRight = y + 7;
          pdf.setFont('helvetica', 'bold');
          pdf.setFontSize(14);
          pdf.text("LISTA DE EMPAQUE", midPoint + 5, yRight);
          pdf.setLineWidth(0.5);
          pdf.line(midPoint + 5, yRight + 1.5, midPoint + 60, yRight + 1.5);
          pdf.setLineWidth(0.2);
          pdf.setFont('helvetica', 'normal');
          pdf.setFontSize(9);
          yRight += 8;
          pdf.text(`Cliente:`, midPoint + 5, yRight);
          pdf.setFont('helvetica', 'bold');
          pdf.setFontSize(11);
          pdf.text(`${clienteNombre || 'N/A'}`, midPoint + 20, yRight);
          pdf.setFont('helvetica', 'normal');
          pdf.setFontSize(9);
          yRight += 5;
          pdf.text(`Operario (Legajo):`, midPoint + 5, yRight);
          pdf.setFont('helvetica', 'bold');
          pdf.text(`${operarioLegajo || 'N/A'}`, midPoint + 33, yRight);
          pdf.setFont('helvetica', 'normal');
          yRight += 5;
          const now = new Date();
          const formattedDate = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;
          const formattedTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
          pdf.text(`Fecha y Hora:`, midPoint + 5, yRight);
          pdf.setFont('helvetica', 'bold');
          pdf.text(`${formattedDate} ${formattedTime}`, midPoint + 26, yRight);
          y = 45;
          const headers = ["SKU", "Descripción", "Lote", "F. Prod.", "F. Venc.", "Cant.", "U.M.", "Control"];
          const colWidths = [0.12, 0.33, 0.15, 0.1, 0.1, 0.06, 0.05, 0.09];
          const colPos = colWidths.reduce((acc, width, i) => {
              acc.push( (i === 0 ? m : acc[i - 1]) + (i === 0 ? 0 : pageWidth * colWidths[i - 1]) );
              return acc;
          }, []);
          const drawHeader = (currentY) => {
              pdf.setFont('helvetica', 'bold');
              pdf.setFontSize(8);
              pdf.setFillColor(230, 230, 230);
              pdf.rect(m, currentY, pageWidth, 6, 'F');
              headers.forEach((h, i) => pdf.text(h, colPos[i] + 2, currentY + 4.5));
              return currentY + 6;
          };
          y = drawHeader(y);
          const rowHeight = 5;
          const startTableY = y;
          pdf.setFont('helvetica', 'normal');
          pdf.setFontSize(7);
          items.forEach((item) => {
            if (y + rowHeight > pdfHeight - m - 20) {
              pdf.addPage();
              y = m;
              y = drawHeader(y);
              pdf.setFontSize(7);
            }
            pdf.line(m, y, pdfWidth - m, y);
            const itemData = [item.sku, item.descripcion, item.lote, item.fechaProduccion, item.fechaVencimiento, item.cantidad, item.unidadMedida].map(d => String(d || ''));
            itemData.forEach((data, i) => pdf.text(data, colPos[i] + 2, y + 3.5));
            const boxSize = 3;
            pdf.rect(colPos[7] + (pageWidth * colWidths[7] / 2) - (boxSize / 2), y + (rowHeight / 2) - (boxSize / 2), boxSize, boxSize);
            y += rowHeight;
          });
          pdf.line(m, y, pdfWidth - m, y);
          colPos.forEach(pos => pdf.line(pos, startTableY, pos, y));
          pdf.line(pdfWidth - m, startTableY, pdfWidth - m, y);
          pdf.setFont('helvetica', 'bold');
          pdf.setFontSize(12);
          pdf.text(`Total de bultos escaneados: ${items.length}`, m, y + 10);
          const totalPages = pdf.internal.getNumberOfPages();
          for (let i = 1; i <= totalPages; i++) {
              pdf.setPage(i);
              let footerY = pdfHeight - 20;
              pdf.setFontSize(10);
              pdf.text("Responsable de Carga:", m, footerY);
              pdf.line(m + 45, footerY, m + 125, footerY);
              footerY += 5;
              pdf.setFontSize(8);
              pdf.text("Firma y Aclaración", m + 65, footerY);
          }
          return pdf;
        } catch (error) {
          console.error("Error al crear el documento PDF:", error);
          setModalContent({ title: 'Error de PDF', message: `Error: ${error.message}` });
          setShowInfoModal(true);
          return null;
        } finally {
          setIsGenerating(false);
          setIsActionsOpen(false);
        }
      };
      const showFeedback = (message) => {
        setFeedbackMessage(message);
        setTimeout(() => setFeedbackMessage(''), 2000);
      };
      const getPdfFilename = () => {
        const date = new Date();
        const dateString = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
        const timeString = `${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}`;
        return `Lista_Empaque_${dateString}-${timeString}_${operarioLegajo}.pdf`;
      }
      const handleDownloadPdf = async () => { 
        const pdf = await createPdfDocument(); 
        if (pdf) { 
          pdf.save(getPdfFilename()); 
          showFeedback('PDF descargado.'); 
        } 
      };
      const handlePrintPdf = async () => { 
        const pdf = await createPdfDocument(); 
        if (pdf) {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = pdf.output('bloburl');
            document.body.appendChild(iframe);
            iframe.contentWindow.print();
        }
      };
      const handleEmailPdf = async () => {
        const pdf = await createPdfDocument();
        if (pdf) {
            const pdfName = getPdfFilename();
            pdf.save(pdfName);
            const mailtoLink = `mailto:?subject=${encodeURIComponent(`Lista de Empaque - Cliente: ${clienteNombre || 'N/A'}`)}&body=${encodeURIComponent(`Hola,\n\nEl archivo "${pdfName}" se ha descargado. Por favor, adjúntalo a este correo.\n\nGenerado por MOLDERIL Inventory Scanner.`)}`;
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            iframe.src = mailtoLink;
            setTimeout(() => {
                document.body.removeChild(iframe);
            }, 500);
        }
      };
      const handleWhatsAppPdf = async () => {
        const pdf = await createPdfDocument();
        if (pdf) {
            const pdfName = getPdfFilename();
            pdf.save(pdfName);
            setModalContent({ title: 'Enviar por WhatsApp', message: `El archivo "${pdfName}" se ha descargado. Ahora se abrirá WhatsApp Web para que lo adjuntes.` });
            setShowInfoModal(true);
            window.open('https://web.whatsapp.com/', '_blank');
        }
      };
      const handleShare = async () => {
        const pdf = await createPdfDocument();
        if (!pdf) return;
        const pdfBlob = pdf.output('blob');
        const pdfFile = new File([pdfBlob], getPdfFilename(), { type: 'application/pdf' });
        const shareData = {
            files: [pdfFile],
            title: `Lista de Empaque - ${clienteNombre}`,
            text: `Lista de empaque generada para el cliente ${clienteNombre}.`,
        };
        if (navigator.canShare && navigator.canShare(shareData)) {
            try {
                await navigator.share(shareData);
                showFeedback('¡Contenido compartido!');
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error al compartir:', error);
                    setModalContent({ title: 'Error al Compartir', message: `Ocurrió un error: ${error.message}` });
                    setShowInfoModal(true);
                }
            }
        } else {
            setModalContent({ title: 'No se puede compartir', message: `Tu navegador no soporta compartir este tipo de archivo. Por favor, descarga el PDF y compártelo manualmente.` });
            setShowInfoModal(true);
        }
      };
      const handleCopyJson = () => {
        setIsActionsOpen(false);
        const jsonString = JSON.stringify(items.map(({ id, controlado, ...rest }) => rest), null, 2);
        const copyToClipboard = (text) => {
          if (navigator.clipboard && window.isSecureContext) {
            return navigator.clipboard.writeText(text);
          } else {
            let textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-99999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            return new Promise((res, rej) => {
              document.execCommand('copy') ? res() : rej();
              textArea.remove();
            });
          }
        };
        copyToClipboard(jsonString)
          .then(() => showFeedback('¡JSON copiado!'))
          .catch(() => {
            setModalContent({ title: 'Error', message: 'No se pudo copiar el contenido JSON.' });
            setShowInfoModal(true);
          });
      };
      const handleReset = () => { setIsDataEntered(false); setOperarioLegajo(''); setClienteNombre(''); setItems([]); };
      
        return isDataEntered ? (
            <div className="min-h-screen bg-gray-100 p-4 flex flex-col">
                {/* The rest of the PackingListScanner UI */}
            </div>
        ) : (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                {/* The initial login form */}
            </div>
        );
    };

    // --- MAIN APP ROUTER ---
    const App = () => {
        const [currentView, setCurrentView] = useState('menu'); // 'menu', 'generator', 'scanner'
        const [isAppReady, setIsAppReady] = useState(false);

        useEffect(() => {
          // This effect now only manages the static loader visibility
          const staticLoader = document.getElementById('static-loader');
          // Simulate loading time
          setTimeout(() => {
              if (staticLoader) {
                  staticLoader.classList.add('opacity-0');
                  setTimeout(() => {
                      staticLoader.remove();
                  }, 500);
              }
              setIsAppReady(true);
          }, 2000); // Keep the loader for 2 seconds
        }, []);

        if (!isAppReady) {
            return null; // Static loader is visible
        }

        if (currentView === 'generator') {
            return <QrGenerator onBackToMenu={() => setCurrentView('menu')} />;
        }

        if (currentView === 'scanner') {
            return <PackingListScanner onBackToMenu={() => setCurrentView('menu')} />;
        }

        // Main Menu View
        return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
                    <h1 className="text-4xl font-extrabold text-gray-900 mb-8">MOLDERIL S.A.</h1>
                    <div className="space-y-4">
                        <button onClick={() => setCurrentView('generator')} className="w-full bg-blue-600 text-white font-semibold py-4 px-4 rounded-md shadow-md hover:bg-blue-700 text-2xl">
                            <i className="fas fa-qrcode mr-3"></i>
                            Generar Etiqueta QR
                        </button>
                        <button onClick={() => setCurrentView('scanner')} className="w-full bg-purple-600 text-white font-semibold py-4 px-4 rounded-md shadow-md hover:bg-purple-700 text-2xl">
                            <i className="fas fa-barcode mr-3"></i>
                            Escanear Lista de Empaque
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
