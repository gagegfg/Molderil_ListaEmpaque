<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MOLDERIL - Generar Etiqueta QR</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    .label-print-page {
      width: 210mm;
      height: 297mm;
      display: flex;
      justify-content: center;
      align-items: center;
      page-break-after: always;
      box-sizing: border-box;
    }
    .label-container {
      width: 190mm;
      height: 277mm;
      border: 2px solid black;
      display: flex;
      flex-direction: column;
      background-color: white;
    }
    #printable-label-container {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      background-color: #e5e7eb;
    }
    @media print {
      body, html { margin: 0; padding: 0; }
      .no-print { display: none; }
      .label-print-page { margin: 0; padding: 0; }
      body * { visibility: hidden; }
      #print-section, #print-section * { visibility: visible; }
      #print-section { position: absolute; left: 0; top: 0; }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">

  <div id="static-loader" class="fixed inset-0 bg-gray-100 flex items-center justify-center p-4 font-sans z-50 transition-opacity duration-500">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
      <h1 class="text-4xl font-extrabold text-gray-900 tracking-wide mb-6">MOLDERIL S.A.</h1>
      <p id="loader-status" class="text-xl text-gray-600 mb-4">Cargando aplicación...</p>
      <div class="w-full bg-gray-200 rounded-full h-4">
        <div id="loader-progress" class="bg-indigo-600 h-4 rounded-full transition-all duration-500" style="width: 10%"></div>
      </div>
    </div>
  </div>

  <div id="root"></div>
  <div id="print-section"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, Fragment } = React;
    const { createRoot } = ReactDOM;

    const USUARIO_GITHUB = 'gagegfg';
    const REPO_NOMBRE = 'Molderil_ListaEmpaque';
    const RUTA_DEL_ARCHIVO = 'lotelogistica.txt';

    const QrCanvas = ({ qrString, sizeMM }) => {
      const canvasRef = useRef(null);
      useEffect(() => {
        if (canvasRef.current && qrString) {
          const pxPerMM = 300 / 25.4; // 300 dpi
          const sizePX = Math.round(sizeMM * pxPerMM);
          canvasRef.current.width = sizePX;
          canvasRef.current.height = sizePX;
          QRCode.toCanvas(canvasRef.current, qrString, { width: sizePX, margin: 0, scale: 1 }, (error) => {
            if (error) console.error(error);
          });
        }
      }, [qrString, sizeMM]);
      return <canvas ref={canvasRef} style={{ width: '100%', height: '100%' }}></canvas>;
    };

    const App = ({ apiToken }) => {
      const [operario, setOperario] = useState('');
      const [articulos, setArticulos] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedArticulo, setSelectedArticulo] = useState(null);
      const [loteProduccion, setLoteProduccion] = useState('');
      const [loteLogistico, setLoteLogistico] = useState('');
      const [isLoteEditable, setIsLoteEditable] = useState(false);
      const [cantidadEtiquetas, setCantidadEtiquetas] = useState(1);
      const [fechaProd, setFechaProd] = useState(new Date().toISOString().split('T')[0]);
      const [fechaVenc, setFechaVenc] = useState('');
      const [cantidad, setCantidad] = useState('');
      const [uom, setUom] = useState('Unidad');
      const [generatedData, setGeneratedData] = useState(null);
      const [printData, setPrintData] = useState([]);

      // Carga inicial
      useEffect(() => {
        const staticLoader = document.getElementById('static-loader');
        const loaderStatus = document.getElementById('loader-status');
        const loaderProgress = document.getElementById('loader-progress');

        const fetchLote = async () => {
          try {
            const url = `https://raw.githubusercontent.com/${USUARIO_GITHUB}/${REPO_NOMBRE}/main/${RUTA_DEL_ARCHIVO}`;
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) throw new Error("No se pudo leer lote");
            const num = parseInt((await res.text()).trim(), 10);
            if (isNaN(num)) throw new Error("Lote inválido");
            setLoteLogistico(num + 1);
          } catch (err) {
            alert(err.message);
            setLoteLogistico('');
            setIsLoteEditable(true);
          }
        };

        const fetchArticulos = async () => {
          try {
            const res = await fetch('articulos.csv');
            const text = await res.text();
            const rows = text.split('\n').slice(1);
            const parsed = rows.map(r => {
              const [tipo, sku, desc] = r.split(';');
              return { tipo: tipo?.trim().toUpperCase(), sku, descripcion: desc?.trim() };
            }).filter(a => a.sku && a.descripcion);
            setArticulos(parsed);
          } catch {
            alert("Error cargando artículos");
          }
        };

        const tasks = [
          { status: "Inicializando...", p: 20 },
          { status: "Cargando lote...", p: 50, fn: fetchLote },
          { status: "Cargando artículos...", p: 85, fn: fetchArticulos },
          { status: "Listo", p: 100 }
        ];

        let i = 0;
        const run = () => {
          if (i < tasks.length) {
            loaderStatus.textContent = tasks[i].status;
            loaderProgress.style.width = tasks[i].p + "%";
            if (tasks[i].fn) tasks[i].fn();
            setTimeout(() => { i++; run(); }, 500);
          } else {
            staticLoader.classList.add('opacity-0');
            setTimeout(() => staticLoader.remove(), 500);
          }
        };
        run();
      }, []);

      const updateGitHubFile = async (contenido) => {
        try {
          const url = `https://api.github.com/repos/${USUARIO_GITHUB}/${REPO_NOMBRE}/contents/${RUTA_DEL_ARCHIVO}`;
          const fileRes = await fetch(url, { headers: { Authorization: `token ${apiToken}` } });
          if (!fileRes.ok) throw new Error("No se pudo obtener info del archivo");
          const fileData = await fileRes.json();
          const updateRes = await fetch(url, {
            method: 'PUT',
            headers: { Authorization: `token ${apiToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: `Actualizando lote a ${contenido}`,
              content: btoa(String(contenido)),
              sha: fileData.sha
            })
          });
          if (!updateRes.ok) throw new Error("Falló actualización");
        } catch (err) {
          alert("Error guardando lote: " + err.message);
        }
      };

      const handlePrint = () => {
        const num = parseInt(cantidadEtiquetas, 10);
        const loteIni = parseInt(loteLogistico, 10);
        if (isNaN(num) || num < 1 || isNaN(loteIni)) {
          alert("Cantidad/lote inválidos");
          return;
        }
        const loteFin = loteIni + num - 1;
        if (confirm(`Imprimir ${num} etiquetas (${loteIni} a ${loteFin})`)) {
          const etiquetas = [];
          for (let i = 0; i < num; i++) {
            etiquetas.push({ ...generatedData, palletId: loteIni + i });
          }
          setPrintData(etiquetas);
          updateGitHubFile(loteFin);
        }
      };

      useEffect(() => {
        if (printData.length > 0) {
          window.print();
          setPrintData([]);
        }
      }, [printData]);

      const handleGenerateLabel = () => {
        if (!operario || !selectedArticulo || !loteLogistico || !cantidad) {
          alert("Complete todos los campos obligatorios");
          return;
        }
        const formatDate = (d) => {
          if (!d) return '';
          const date = new Date(d + 'T00:00:00');
          return date.toLocaleDateString('es-ES');
        };
        const qrData = [
          selectedArticulo.sku,
          selectedArticulo.descripcion,
          loteProduccion,
          formatDate(fechaProd),
          formatDate(fechaVenc),
          cantidad,
          uom
        ].join(';');

        setGeneratedData({
          sku: selectedArticulo.sku,
          descripcion: selectedArticulo.descripcion,
          lote: loteProduccion,
          cantidad: parseFloat(cantidad.replace(',', '.')),
          uom,
          fechaProd,
          fechaVenc,
          operario,
          palletId: loteLogistico,
          qrString: qrData
        });
      };

      useEffect(() => {
        if (fechaProd) {
          const d = new Date(fechaProd);
          d.setFullYear(d.getFullYear() + 3);
          setFechaVenc(d.toISOString().split('T')[0]);
        }
      }, [fechaProd]);

      useEffect(() => {
        if (selectedArticulo) {
          const especiales = ['TULIPAS', 'PIROTINES', 'MADALENAS', 'FUNDAS'];
          setUom(especiales.includes(selectedArticulo.tipo) ? 'Millar' : 'Unidad');
        }
      }, [selectedArticulo]);

      const filtered = searchTerm ? articulos.filter(a => a.sku.toLowerCase().includes(searchTerm.toLowerCase()) || a.descripcion.toLowerCase().includes(searchTerm.toLowerCase())) : [];
      const fmtNum = (n) => isNaN(n) ? '' : new Intl.NumberFormat('es-ES').format(n);

      const LabelComponent = ({ data }) => (
        <div className="label-container text-black">
          <div className="text-center border-b-2 border-black p-4">
            <h2 className="text-5xl font-bold">MOLDERIL S.A.</h2>
          </div>
          <div className="border-b-2 border-black p-4 flex flex-col flex-grow-[3]">
            <p className="text-2xl">Artículo</p>
            <p className="font-bold leading-none" style={{ fontSize: '6rem' }}>{data.descripcion}</p>
            <div className="flex justify-between text-2xl mt-2">
              <span>SKU: {data.sku}</span>
              {data.lote && <span>Lote Prod: {data.lote}</span>}
            </div>
          </div>
          <div className="border-b-2 border-black p-4 flex flex-col flex-grow-[2]">
            <p className="text-2xl">Cantidad</p>
            <p className="font-bold" style={{ fontSize: '5rem' }}>
              {fmtNum(data.cantidad)} <span className="text-5xl">{data.uom}</span>
            </p>
          </div>
          <div className="flex-grow-[5] flex justify-center items-center p-4">
            <QrCanvas qrString={data.qrString} sizeMM={100} />
          </div>
          <div className="grid grid-cols-3 text-center border-t-2 border-black p-4 text-2xl">
            <div><p className="font-bold">Lote Logístico</p><p className="font-bold text-6xl">{data.palletId}</p></div>
            <div><p className="font-bold">Fabricación</p><p>{new Date(data.fechaProd).toLocaleDateString('es-ES')}</p></div>
            <div><p className="font-bold">Vencimiento</p><p>{new Date(data.fechaVenc).toLocaleDateString('es-ES')}</p></div>
          </div>
        </div>
      );

      return (
        <Fragment>
          <div className="min-h-screen bg-gray-100 p-4 flex flex-col">
            <div className="bg-white p-6 rounded-xl shadow-lg flex-grow">
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-3xl font-extrabold">Generar Etiqueta de Pallet</h1>
                <a href="index.html" className="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 no-print">Volver</a>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-4">
                  <div>
                    <label>Operario (Legajo)</label>
                    <input type="text" value={operario} onChange={(e) => setOperario(e.target.value.replace(/[^0-9]/g, ''))} className="mt-1 block w-full border p-2 rounded-md" />
                  </div>
                  <div className="relative">
                    <label>Artículo</label>
                    <input type="text" value={searchTerm} onChange={(e) => { setSearchTerm(e.target.value); setSelectedArticulo(null); }} className="mt-1 block w-full border p-2 rounded-md" />
                    {searchTerm && (
                      <ul className="absolute z-10 w-full bg-white border rounded-md mt-1 max-h-40 overflow-y-auto shadow-lg">
                        {filtered.map(art => (
                          <li key={art.sku} className="p-2 hover:bg-indigo-100 cursor-pointer" onClick={() => { setSelectedArticulo(art); setSearchTerm(`${art.sku} - ${art.descripcion}`); }}>
                            {art.sku} - {art.descripcion}
                          </li>
                        ))}
                      </ul>
                    )}
                  </div>
                  <div>
                    <label>Lote de Producción</label>
                    <input type="text" value={loteProduccion} onChange={(e) => setLoteProduccion(e.target.value)} className="mt-1 block w-full border p-2 rounded-md" />
                  </div>
                  <div>
                    <label>Lote Logístico</label>
                    <input type="number" value={loteLogistico} readOnly={!isLoteEditable} onChange={(e) => setLoteLogistico(e.target.value)} className={`mt-1 block w-full border p-2 rounded-md ${!isLoteEditable ? 'bg-gray-100' : ''}`} />
                  </div>
                  <div>
                    <label>Cantidad de Etiquetas</label>
                    <input type="number" min="1" value={cantidadEtiquetas} onChange={(e) => setCantidadEtiquetas(e.target.value)} className="mt-1 block w-full border p-2 rounded-md" />
                  </div>
                  <div>
                    <label>Fecha Producción</label>
                    <input type="date" value={fechaProd} onChange={(e) => setFechaProd(e.target.value)} className="mt-1 block w-full border p-2 rounded-md" />
                  </div>
                  <div>
                    <label>Fecha Vencimiento</label>
                    <input type="date" value={fechaVenc} readOnly className="mt-1 block w-full border p-2 rounded-md bg-gray-100" />
                  </div>
                  <div>
                    <label>Cantidad</label>
                    <input type="text" value={cantidad} onChange={(e) => setCantidad(e.target.value)} className="mt-1 block w-full border p-2 rounded-md" />
                  </div>
                  <div>
                    <label>Unidad de Medida</label>
                    <select value={uom} onChange={(e) => setUom(e.target.value)} className="mt-1 block w-full border p-2 rounded-md">
                      <option>Unidad</option>
                      <option>Millar</option>
                    </select>
                  </div>
                  <button onClick={handleGenerateLabel} className="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700">Generar Vista Previa</button>
                </div>
                <div>
                  <h3 className="text-lg mb-2">Vista Previa</h3>
                  <div id="printable-label-container" className="border-2 border-dashed border-gray-400 w-full" style={{ height: '60vh' }}>
                    {generatedData ? (
                      <div style={{ transform: 'scale(0.23)', transformOrigin: 'center' }}>
                        <LabelComponent data={generatedData} />
                      </div>
                    ) : (
                      <div className="text-center text-gray-500 flex items-center justify-center h-full">Complete el formulario</div>
                    )}
                  </div>
                  {generatedData && (
                    <button onClick={handlePrint} className="w-full mt-4 bg-green-600 text-white py-3 rounded-md hover:bg-green-700">Imprimir y Guardar Lotes</button>
                  )}
                </div>
              </div>
            </div>
          </div>

          <div id="print-section">
            {printData.map((label, i) => (
              <div key={i} className="label-print-page">
                <LabelComponent data={label} />
              </div>
            ))}
          </div>
        </Fragment>
      );
    };

    async function getApiToken() {
      try {
        const res = await fetch('cls.txt');
        if (!res.ok) throw new Error("No se pudo cargar cls.txt");
        let token = await res.text();
        token = token.replace(/aaaa/g, '').replace(/bbbb/g, '').replace(/cccc/g, '');
        return token.trim();
      } catch (err) {
        alert("Error crítico: " + err.message);
        return null;
      }
    }

    (async () => {
      const token = await getApiToken();
      if (token) {
        const root = createRoot(document.getElementById('root'));
        root.render(<App apiToken={token} />);
      } else {
        document.getElementById('loader-status').textContent = "No se pudo iniciar";
      }
    })();
  </script>
</body>
</html>
