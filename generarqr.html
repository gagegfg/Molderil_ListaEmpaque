<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MOLDERIL - Generar Etiqueta QR</title>
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<style>
  .label-print-page {
    width: 210mm;
    height: 297mm;
    display: flex;
    justify-content: center;
    align-items: center;
    page-break-after: always;
    box-sizing: border-box;
  }
  .label-container {
    width: 190mm;
    height: 277mm;
    border: 2px solid black;
    display: flex;
    flex-direction: column;
    background-color: white;
    page-break-inside: avoid;
  }
  #printable-label-container {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background-color: #f3f4f6;
  }
  @media print {
    body, html { margin: 0; padding: 0; }
    .no-print { display: none; }
    body * { visibility: hidden; }
    #print-section, #print-section * { visibility: visible; }
    #print-section { position: absolute; left: 0; top: 0; }
  }
</style>
</head>
<body class="bg-gray-100 font-sans">

<div id="static-loader" class="fixed inset-0 bg-gray-100 flex items-center justify-center p-4 z-50 transition-opacity duration-500">
  <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-6">MOLDERIL S.A.</h1>
    <p id="loader-status" class="text-xl text-gray-600 mb-4">Cargando aplicación...</p>
    <div class="w-full bg-gray-200 rounded-full h-4">
      <div id="loader-progress" class="bg-indigo-600 h-4 rounded-full transition-all duration-500" style="width: 10%"></div>
    </div>
  </div>
</div>

<div id="root"></div>
<div id="print-section"></div>

<script type="text/babel">
const { useState, useEffect, Fragment } = React;
const { createRoot } = ReactDOM;

const USUARIO_GITHUB = 'gagegfg';
const REPO_NOMBRE = 'Molderil_ListaEmpaque';
const RUTA_DEL_ARCHIVO = 'lotelogistica.txt';

const QrImage = ({ qrString, sizeMM }) => {
  const [src, setSrc] = useState('');
  useEffect(() => {
    const pxPerMM = 300 / 25.4;
    const sizePX = Math.round(sizeMM * pxPerMM);
    QRCode.toDataURL(qrString, { width: sizePX, margin: 0 }, (err, url) => {
      if (!err) setSrc(url);
    });
  }, [qrString, sizeMM]);
  return <img src={src} alt="QR" style={{ width: '100%', height: '100%' }} />;
};

const App = ({ apiToken }) => {
  const [articulos, setArticulos] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedArticulo, setSelectedArticulo] = useState(null);
  const [loteProduccion, setLoteProduccion] = useState('');
  const [loteLogistico, setLoteLogistico] = useState('');
  const [isLoteEditable, setIsLoteEditable] = useState(false);
  const [cantidadEtiquetas, setCantidadEtiquetas] = useState(1);
  const [fechaProd, setFechaProd] = useState(new Date().toISOString().split('T')[0]);
  const [fechaVenc, setFechaVenc] = useState('');
  const [cantidad, setCantidad] = useState('');
  const [uom, setUom] = useState('Unidad');
  const [generatedData, setGeneratedData] = useState(null);
  const [printData, setPrintData] = useState([]);
  const [showPrintBtn, setShowPrintBtn] = useState(false);
  const [lastLote, setLastLote] = useState(null);
  const [googleDocsText, setGoogleDocsText] = useState('');

  useEffect(() => {
    // ... (código de carga inicial sin cambios) ...
  }, []);

  const updateGitHubFile = async (contenido) => {
    // ... (código de actualización de GitHub sin cambios) ...
  };

  const handleGenerateLabel = () => {
    if (!selectedArticulo || !loteLogistico || !cantidad) {
      alert("Complete todos los campos obligatorios");
      return;
    }
    const validCantidad = /^\d+([,]\d+)?$/.test(cantidad) && parseFloat(cantidad.replace(',', '.')) > 0;
    if (!validCantidad) {
      alert("Cantidad inválida");
      return;
    }
    const formatDate = (d) => new Date(d + 'T00:00:00').toLocaleDateString('es-ES');
    const qrData = [selectedArticulo.sku, selectedArticulo.descripcion, loteProduccion, formatDate(fechaProd), formatDate(fechaVenc), cantidad, uom].join(';');

    const data = {
      sku: selectedArticulo.sku,
      descripcion: selectedArticulo.descripcion,
      lote: loteProduccion,
      cantidad: parseFloat(cantidad.replace(',', '.')),
      uom,
      fechaProd,
      fechaVenc,
      palletId: loteLogistico,
      qrString: qrData
    };
    setGeneratedData(data);
    setShowPrintBtn(true);
    
    // --- NUEVO: Generar texto para Google Docs ---
    const textForDoc = `MOLDERIL S.A.\n\n` +
      `ARTICULO,${data.descripcion},SKU: ${data.sku}\n` +
      `${new Intl.NumberFormat('es-ES').format(data.cantidad)} ${data.uom}\n\n` +
      `Lote Logístico,${data.palletId},Fabricación,${formatDate(data.fechaProd)},Vencimiento,${formatDate(data.fechaVenc)}`;
    setGoogleDocsText(textForDoc);
  };

  const handlePrint = () => {
    // ... (código de impresión sin cambios) ...
  };

  // ... (resto de funciones sin cambios: handleNewPrint, useEffect de fechas, etc.) ...

  const LabelComponent = ({ data }) => (
    // ... (componente de la etiqueta visual sin cambios) ...
  );

  return (
    <Fragment>
      <div className="min-h-screen bg-gray-100 p-4 flex flex-col">
        <div className="bg-white p-6 rounded-xl shadow-lg flex-grow">
          {/* ... (resto del formulario sin cambios) ... */}

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* ... (columna de formulario sin cambios) ... */}
            
            <div>
              <h3 className="text-lg mb-2">Vista Previa</h3>
              <div id="printable-label-container" className="border-2 border-dashed border-gray-400 w-full" style={{ height: '50vh' }}>
                {generatedData ? (
                  <div style={{ transform: 'scale(0.20)', transformOrigin: 'center' }}>
                    <LabelComponent data={generatedData} />
                  </div>
                ) : (
                  <div className="text-center text-gray-500 flex items-center justify-center h-full">Complete el formulario</div>
                )}
              </div>

              {/* --- NUEVO: Área de texto para Google Docs --- */}
              {googleDocsText && (
                <div className="mt-4">
                  <label className="text-lg mb-2">Para Google Docs</label>
                  <textarea
                    readOnly
                    className="w-full h-48 p-2 border rounded-md bg-gray-50 font-mono"
                    value={googleDocsText}
                    onClick={(e) => e.target.select()}
                  ></textarea>
                  <p className="text-sm text-gray-500 mt-1">
                    Haz clic en el texto y presiona Ctrl+C (o Cmd+C) para copiar. Luego, pégalo en un nuevo documento de Google.
                  </p>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
      <div id="print-section">{/* ... (sección de impresión sin cambios) ... */}</div>
    </Fragment>
  );
};

// ... (resto del script sin cambios: getApiToken, etc.) ...
</script>
</body>
</html>
