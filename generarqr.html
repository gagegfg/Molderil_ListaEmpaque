<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLDERIL - Generar Etiqueta QR (v6 - Carga Directa)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
          background-image: url('fondo.jpg');
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
          background-attachment: fixed;
        }
        .backdrop-blur-lg {
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }
        #preview-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        #preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-success { background-color: #16a34a; }
        .toast-error { background-color: #dc2626; }
        .toast-info { background-color: #2563eb; }
        .spinner {
            display: inline-block;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 18px;
            height: 18px;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

<div id="static-loader" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 p-4 font-sans z-50 transition-opacity duration-500">
    <div class="relative bg-[#D2B48C]/20 backdrop-blur-lg border border-[#D2B48C]/30 p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
        <img src="logo.jpg" alt="Logo Molderil" class="mx-auto mb-6 h-32 [filter:drop-shadow(2px_2px_4px_rgba(0,0,0,0.4))_drop_shadow(-2px_-2px_4px_rgba(255,255,255,0.6))]"/>
        <p id="loader-status" class="text-xl text-white mb-4 [text-shadow:_1px_1px_2px_rgba(0,0,0,0.5)]">Cargando aplicaci√≥n...</p>
        <div class="w-full bg-white/20 rounded-full h-4 border border-white/30">
            <div id="loader-progress" class="bg-amber-400 h-full rounded-full transition-all duration-500" style="width: 10%"></div>
        </div>
    </div>
</div>


<div id="root"></div>
<div id="toast-container"></div>

<script type="text/babel">
    const { useState, useEffect, Fragment, useRef } = React;
    const { createRoot } = ReactDOM;
    const { jsPDF } = window.jspdf;

    const Toast = ({ message, type, onHide }) => {
        useEffect(() => {
            const timer = setTimeout(onHide, 4000);
            return () => clearTimeout(timer);
        }, [onHide]);

        return (
            <div className={`toast show toast-${type}`}>
                {message}
            </div>
        );
    };
    
    const useToasts = () => {
        const [toasts, setToasts] = useState([]);
        const toastContainer = document.getElementById('toast-container');

        const showToast = (message, type = 'info') => {
            const id = Date.now();
            setToasts(prev => [...prev, { id, message, type }]);
        };

        useEffect(() => {
            const onHide = (id) => {
                setToasts(prev => prev.filter(toast => toast.id !== id));
            };
            
            const toastElements = toasts.map(toast => (
                <Toast key={toast.id} {...toast} onHide={() => onHide(toast.id)} />
            ));
            
            if (toastContainer) {
                ReactDOM.createPortal(toastElements, toastContainer);
            }
        }, [toasts, toastContainer]);

        return showToast;
    };

    const App = () => {
        const showToast = useToasts();
        const [appIsLoading, setAppIsLoading] = useState(true);
        const [articulos, setArticulos] = useState([]);
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedArticulo, setSelectedArticulo] = useState(null);
        const [lotesProduccion, setLotesProduccion] = useState(['']);
        const [numeroDePallet, setNumeroDePallet] = useState('');
        const [cantidadCopias, setCantidadCopias] = useState(2);
        
        const getTodayDateString = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const [fechaProd, setFechaProd] = useState(getTodayDateString());

        const [cantidad, setCantidad] = useState('');
        const [uom, setUom] = useState('Unidad');
        const [previewPdfUrl, setPreviewPdfUrl] = useState(null);
        const [isSaving, setIsSaving] = useState(false);
        const [observacion, setObservacion] = useState('');
        const [legajo, setLegajo] = useState('');
        const [cliente, setCliente] = useState('');
        const [transporte, setTransporte] = useState('');
        const [remito, setRemito] = useState('');
        const [ordenDeCompra, setOrdenDeCompra] = useState('');
        const [bultos, setBultos] = useState('');

        const articuloInputRef = useRef(null);
        const loteInputRefs = useRef([]);
        
        const handleRefreshPalletNumber = async () => {
            try {
                const response = await fetch('/api/getPalletNumber', { cache: "no-store" });
                const data = await response.json();
                if (!data.success) throw new Error(data.message);
                const nextPallet = data.palletNumber + 1;
                setNumeroDePallet(nextPallet);
                showToast(`N√∫mero de pallet actualizado: ${nextPallet}`, 'success');
            } catch (error) {
                showToast(`Error al refrescar pallet: ${error.message}`, 'error');
            }
        };

        useEffect(() => {
            const staticLoader = document.getElementById('static-loader');
            const loaderStatus = document.getElementById('loader-status');
            const loaderProgress = document.getElementById('loader-progress');

            const fetchInitialData = async () => {
                try {
                    loaderStatus.textContent = "Cargando n√∫mero de pallet...";
                    loaderProgress.style.width = '33%';
                    const palletResponse = await fetch('/api/getPalletNumber', { cache: "no-store" });
                    const palletData = await palletResponse.json();
                    if (!palletData.success) throw new Error(palletData.message);
                    setNumeroDePallet(palletData.palletNumber + 1);

                    loaderStatus.textContent = "Cargando lista de art√≠culos...";
                    loaderProgress.style.width = '66%';
                    const articulosResponse = await fetch('/api/getArticulos', { cache: "no-store" });
                    const articulosData = await articulosResponse.json();
                    if (!articulosData.success) throw new Error(articulosData.message);
                    setArticulos(articulosData.articles);

                    loaderStatus.textContent = "¬°Listo!";
                    loaderProgress.style.width = '100%';
                    setTimeout(() => {
                        staticLoader.classList.add('opacity-0');
                        setTimeout(() => { staticLoader.style.display = 'none'; setAppIsLoading(false); }, 500);
                    }, 500);

                } catch (error) {
                    loaderStatus.textContent = `Error: ${error.message}`;
                    loaderProgress.classList.add('bg-red-500');
                }
            };

            fetchInitialData();
        }, []);

        useEffect(() => {
            if (!appIsLoading && articuloInputRef.current) {
                articuloInputRef.current.focus();
            }
        }, [appIsLoading]);
        
        useEffect(() => {
            if (selectedArticulo) {
                const specialTypes = ['TULIPAS', 'PIROTINES', 'MADALENAS', 'FUNDAS'];
                if (specialTypes.includes(selectedArticulo.tipo)) { setUom('Millar'); } 
                else { setUom('Unidad'); }
            }
        }, [selectedArticulo]);
        
        useEffect(() => {
            const lastLoteIndex = lotesProduccion.length - 1;
            if (loteInputRefs.current[lastLoteIndex]) {
                loteInputRefs.current[lastLoteIndex].focus();
            }
        }, [lotesProduccion.length]);
        
        const handleLoteProdChange = (index, value) => {
            const regex = /^\d*$/;
            if (regex.test(value)) {
                const nuevosLotes = [...lotesProduccion];
                nuevosLotes[index] = value;
                setLotesProduccion(nuevosLotes);
            }
        };

        const addLoteProdField = () => {
            if (lotesProduccion.length < 4) {
                setLotesProduccion([...lotesProduccion, '']);
            }
        };
        
        const handleCantidadChange = (e) => {
            let value = e.target.value;
            value = value.replace(/[^0-9,]/g, '');
            const parts = value.split(',');
            if (parts.length > 2) {
                value = parts[0] + ',' + parts.slice(1).join('');
            }
            setCantidad(value);
        };
        
        const formatNumberES = (numStr) => {
            if (!numStr) return '';
            const [integerPart, decimalPart] = numStr.split(',');
            const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return decimalPart !== undefined ? `${formattedInteger},${decimalPart}` : formattedInteger;
        };

        const filteredArticulos = searchTerm ? articulos.filter(art => art.sku.toLowerCase().includes(searchTerm.toLowerCase()) || art.desc_larga.toLowerCase().includes(searchTerm.toLowerCase())) : [];

        const drawLabelOnDoc = async (doc, data) => {
            const pageW = 210; const margin = 8; const contentW = pageW - (margin * 2); let currentY = margin;
            doc.setFontSize(24); doc.setFont("helvetica", "bold"); doc.text("MOLDERIL S.A.", pageW / 2, currentY + 8, { align: "center" });
            currentY += 15; doc.line(margin, currentY, pageW - margin, currentY); currentY += 10;
            doc.setFont("helvetica", "bold");
            const baseFontSize = 84;
            doc.setFontSize(baseFontSize);
            let descLines = doc.splitTextToSize(data.descripcion, contentW);
            let finalFontSize = baseFontSize;
            if (descLines.length > 3) { finalFontSize = 60; }
            doc.setFontSize(finalFontSize);
            const lineHeight = finalFontSize / 3;
            doc.text(descLines, pageW / 2, currentY + lineHeight, { align: "center", lineHeightFactor: 1 });
            currentY += (descLines.length * lineHeight) + 10;
            doc.line(margin, currentY, pageW - margin, currentY); currentY += 2;
            doc.setFontSize(20); doc.setFont("helvetica", "bold"); doc.text(`SKU: ${data.sku}`, margin, currentY + 12);
            const lotesProdString = data.lotes.join(' / ');
            const lotesDisplayString = data.observacion ? `${lotesProdString} (*)` : lotesProdString;
            if (lotesProdString) { doc.setFontSize(18); doc.setFont("helvetica", "normal"); doc.text(`Lotes: ${lotesDisplayString}`, pageW - margin, currentY + 12, { align: "right" }); }
            currentY += 18; doc.line(margin, currentY, pageW - margin, currentY); currentY += 8;
            const formattedCantidad = formatNumberES(data.cantidad);
            const uomText = data.uom === 'Unidad' ? 'Unidades' : 'Millares';
            const cantidadString = `${formattedCantidad} ${uomText}`;
            doc.setFont("helvetica", "bold"); doc.setFontSize(44);
            const cantidadWidth = doc.getStringUnitWidth(cantidadString) * doc.getFontSize() / doc.internal.scaleFactor;
            doc.text(cantidadString, (pageW - cantidadWidth) / 2, currentY + 12); currentY += 20;
            const qrSize = 90; const qrX = (pageW - qrSize) / 2; const qrY = currentY;
            const qrImageData = await QRCode.toDataURL(data.qrString, { width: 400, margin: 2, errorCorrectionLevel: 'M' });
            doc.addImage(qrImageData, 'PNG', qrX, qrY, qrSize, qrSize); currentY += qrSize + 5;
            doc.line(margin, currentY, pageW - margin, currentY); currentY += 5;
            doc.setFontSize(22); doc.setFont("helvetica", "bold"); doc.text("N¬∫ de Pallet", margin, currentY + 10); doc.text("Fabricaci√≥n", pageW - margin, currentY + 10, { align: "right" });
            doc.setFontSize(36); doc.text(String(data.palletId), margin, currentY + 22);
            doc.setFontSize(22); doc.text(new Date(data.fechaProd + 'T00:00:00').toLocaleDateString('es-ES'), pageW - margin, currentY + 22, { align: "right" });
        };

        const getLabelData = () => {
            const lotesProduccionFiltrados = lotesProduccion.filter(lote => lote.trim() !== '');
            const items = [{
                sku: selectedArticulo.sku,
                description: selectedArticulo.desc_larga,
                quantity: cantidad,
                uom: uom
            }];
            return {
                palletNumber: numeroDePallet,
                legajo,
                customer: cliente,
                transport,
                remito,
                ordenDeCompra,
                bultos,
                lotes: lotesProduccionFiltrados,
                fechaProduccion: fechaProd,
                notes: observacion.trim(),
                items: items,
                // For label drawing only
                labelDesc: selectedArticulo.desc_corta || selectedArticulo.desc_larga,
            };
        }

        const handleGeneratePreview = async () => {
            const lotesValidos = lotesProduccion.some(lote => lote.trim() !== '');
            if (!selectedArticulo || !cantidad || !lotesValidos || !legajo || !cliente) {
                showToast("Complete todos los campos obligatorios (*).", 'error');
                return;
            }
            const data = getLabelData();
            const doc = new jsPDF('p', 'mm', 'a4');
            const qrString = `${data.items[0].sku};${data.items[0].description};${data.palletNumber};${data.lotes.join('#')};${data.fechaProduccion};${data.items[0].quantity.replace(',', '.')};${data.items[0].uom}`;
            await drawLabelOnDoc(doc, { 
                ...data, 
                descripcion: data.labelDesc, 
                palletId: data.palletNumber,
                fechaProd: data.fechaProduccion,
                cantidad: data.items[0].quantity,
                uom: data.items[0].uom,
                observacion: data.notes,
                qrString
            });
            const pdfDataUrl = doc.output('datauristring');
            setPreviewPdfUrl(pdfDataUrl);
        };
        
        const handleGenerateAndPrintPDF = async () => {
            if (isSaving) return;
            if (!previewPdfUrl) {
                showToast("Primero debe generar una vista previa.", 'error');
                return;
            }
            setIsSaving(true);
            try {
                const saveData = getLabelData();
                const response = await fetch('/api/savePallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(saveData),
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || `Error del servidor: ${response.status}`);
                }

                showToast(`Pallet N¬∫ ${saveData.palletNumber} guardado correctamente.`, 'success');
                
                const numCopias = parseInt(cantidadCopias, 10);
                const doc = new jsPDF('p', 'mm', 'a4');
                const qrString = `${saveData.items[0].sku};${saveData.items[0].description};${saveData.palletNumber};${saveData.lotes.join('#')};${saveData.fechaProduccion};${saveData.items[0].quantity.replace(',', '.')};${saveData.items[0].uom}`;
                for (let i = 0; i < numCopias; i++) {
                    if (i > 0) doc.addPage();
                    await drawLabelOnDoc(doc, { 
                        ...saveData, 
                        descripcion: saveData.labelDesc, 
                        palletId: saveData.palletNumber,
                        fechaProd: saveData.fechaProduccion,
                        cantidad: saveData.items[0].quantity,
                        uom: saveData.items[0].uom,
                        observacion: saveData.notes,
                        qrString
                    });
                }
                
                doc.save(`etiqueta_pallet_${saveData.palletNumber}.pdf`);
                
                // Reset form
                setNumeroDePallet(prev => prev + 1);
                setSelectedArticulo(null);
                setSearchTerm('');
                setLotesProduccion(['']);
                setCantidad('');
                setObservacion('');
                setLegajo('');
                setCliente('');
                setTransporte('');
                setRemito('');
                setOrdenDeCompra('');
                setBultos('');
                setPreviewPdfUrl(null);

            } catch (error) {
                showToast(`ERROR CR√çTICO: ${error.message}`, 'error');
                if (error.message.includes('Conflicto')) {
                    handleRefreshPalletNumber();
                }
            } finally {
                setIsSaving(false);
            }
        };
        
        if (appIsLoading) {
            return null;
        }

        const FormInput = ({ label, value, onChange, required = false, ...props }) => (
            <div>
                <label className="block text-base font-bold text-black">{label} {required && <span className="text-red-500">*</span>}</label>
                <input {...props} value={value} onChange={onChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" />
            </div>
        );

        return (
            <Fragment>
                <div className="min-h-screen p-4 flex flex-col" style={{background: 'rgba(243, 244, 246, 0.8)'}}>
                    <div className="bg-white/30 backdrop-blur-lg border border-white/50 p-6 rounded-xl shadow-lg flex-grow">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-extrabold text-gray-900">Generar Etiqueta de Pallet</h1>
                            <a href="index.html" className="bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-md border-b-4 border-green-800 hover:bg-green-700 active:translate-y-px active:border-b-2 transition-all duration-150 flex items-center">üè† Volver</a>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* Columna Izquierda: Formulario */}
                            <div className="space-y-4">
                                <div className="relative">
                                    <label className="block text-base font-bold text-black">Art√≠culo (SKU o Descripci√≥n) <span className="text-red-500">*</span></label>
                                    <input type="text" ref={articuloInputRef} value={searchTerm} onChange={e => { setSearchTerm(e.target.value); setSelectedArticulo(null); setPreviewPdfUrl(null); }} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" />
                                    {searchTerm && filteredArticulos.length > 0 && (
                                        <ul className="absolute z-10 w-full bg-white border rounded-md mt-1 max-h-40 overflow-y-auto shadow-lg">
                                            {filteredArticulos.map(art => (
                                                <li key={art.sku} className="p-2 hover:bg-indigo-100 cursor-pointer" onClick={() => { setSelectedArticulo(art); setSearchTerm(`${art.sku} - ${art.desc_larga}`); }}>
                                                    {art.sku} - {art.desc_larga}
                                                </li>
                                            ))}
                                        </ul>
                                    )}
                                </div>
                                
                                <FormInput label="Legajo" value={legajo} onChange={e => setLegajo(e.target.value)} required />
                                <FormInput label="Cliente" value={cliente} onChange={e => setCliente(e.target.value)} required />

                                <div>
                                    <label className="block text-base font-bold text-black">Lotes de Producci√≥n <span className="text-red-500">*</span></label>
                                    {lotesProduccion.map((lote, index) => (
                                        <input key={index} ref={el => loteInputRefs.current[index] = el} type="text" value={lote} onChange={e => handleLoteProdChange(index, e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" />
                                    ))}
                                    {lotesProduccion.length < 4 && (<button onClick={addLoteProdField} className="mt-2 text-sm font-semibold text-blue-600 hover:text-blue-800">+ A√±adir lote</button>)}
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <FormInput label="Cantidad" value={cantidad} onChange={handleCantidadChange} required placeholder="Ej: 1234,56" />
                                    <div>
                                        <label className="block text-base font-bold text-black">U.M. <span className="text-red-500">*</span></label>
                                        <select value={uom} onChange={e => setUom(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                            <option>Unidad</option>
                                            <option>Millar</option>
                                        </select>
                                    </div>
                                </div>

                                <FormInput label="Fecha de Producci√≥n" value={fechaProd} onChange={e => setFechaProd(e.target.value)} type="date" required />
                                
                                <div className="grid grid-cols-2 gap-4">
                                    <FormInput label="Transporte" value={transporte} onChange={e => setTransporte(e.target.value)} />
                                    <FormInput label="Bultos" value={bultos} onChange={e => setBultos(e.target.value)} />
                                    <FormInput label="Remito" value={remito} onChange={e => setRemito(e.target.value)} />
                                    <FormInput label="Orden de Compra" value={ordenDeCompra} onChange={e => setOrdenDeCompra(e.target.value)} />
                                </div>

                                <div>
                                    <label className="block text-base font-bold text-black">Observaciones</label>
                                    <textarea value={observacion} onChange={e => setObservacion(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" rows="2"></textarea>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-4">
                                    <FormInput label="N¬∫ de Pallet" value={numeroDePallet} onChange={() => {}} readOnly />
                                    <FormInput label="Copias" value={cantidadCopias} onChange={e => setCantidadCopias(e.target.value)} type="number" min="1" />
                                </div>

                                <button onClick={handleGeneratePreview} className="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-md shadow-md hover:bg-blue-700 text-xl flex items-center justify-center">Generar Vista Previa</button>
                            </div>

                            {/* Columna Derecha: Vista Previa */}
                            <div>
                                <h3 className="text-lg font-medium text-gray-900 mb-2">Vista Previa de Etiqueta</h3>
                                <div id="preview-container" className="border-2 border-dashed border-gray-400 w-full" style={{height: '65vh'}}>
                                    {previewPdfUrl ? (
                                        <iframe id="preview-iframe" src={previewPdfUrl} title="Vista Previa de Etiqueta"></iframe>
                                    ) : (
                                        <div className="text-center text-gray-500 flex items-center justify-center h-full"><p>Complete el formulario y genere la vista previa</p></div>
                                    )}
                                </div>
                                {previewPdfUrl && (
                                    <button onClick={handleGenerateAndPrintPDF} disabled={isSaving} className="w-full mt-4 bg-green-600 text-white font-semibold py-3 px-4 rounded-md shadow-md hover:bg-green-700 text-xl flex items-center justify-center disabled:opacity-60 disabled:cursor-wait">
                                        {isSaving && <span className="spinner"></span>}
                                        {isSaving ? 'Guardando...' : 'üñ®Ô∏è Imprimir y Guardar'}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </Fragment>
        );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);

</script>
</body>
</html>