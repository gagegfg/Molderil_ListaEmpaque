<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLDERIL - Histórico de Lotes (Sincronizado)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
          background-image: url('fondo.jpg');
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
          background-attachment: fixed;
        }
        .backdrop-blur-lg {
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }
        .checkbox-accent:checked {
            background-color: #16a34a; /* green-600 */
            border-color: #15803d; /* green-700 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="static-loader" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 p-4 font-sans z-50">
        <div class="relative bg-[#D2B48C]/20 backdrop-blur-lg border border-[#D2B48C]/30 p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
          <img src="logo.jpg" alt="Logo Molderil" class="mx-auto mb-6 h-32 [filter:drop-shadow(2px_2px_4px_rgba(0,0,0,0.4))_drop-shadow(-2px_-2px_4px_rgba(255,255,255,0.6))]"/>
          <p id="loader-status" class="text-xl text-white mb-4 [text-shadow:_1px_1px_2px_rgba(0,0,0,0.5)]">Cargando aplicación...</p>
          <div class="w-full bg-white/20 rounded-full h-4 border border-white/30">
            <div id="loader-progress" class="bg-amber-400 h-full rounded-full transition-all duration-500" style="width: 10%"></div>
          </div>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const { createRoot } = ReactDOM;
        const { jsPDF } = window.jspdf;

        // --- CONFIGURACIÓN DE GITHUB ---
        const GITHUB_USER = 'gagegfg';
        const GITHUB_REPO = 'Molderil_ListaEmpaque';
        const CSV_PATH_LOTES = 'detallelotes.csv';
        const CSV_PATH_NOTAS = 'notasskulote.csv';
        const CSV_PATH_ALMACENADOS = 'nropalletalmacenado.csv';
        const AUTH_TIMEOUT = 5 * 60 * 1000;

        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.log(error);
                    return initialValue;
                }
            });
            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) { console.log(error); }
            };
            return [storedValue, setValue];
        };
        
        const App = () => {
            const [allData, setAllData] = useState([]);
            const [articulosMap, setArticulosMap] = useState(new Map());
            const [filteredData, setFilteredData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [apiToken, setApiToken] = useState(null);
            const [clientList, setClientList] = useState([]);
            const [authTimestamp, setAuthTimestamp] = useState(null);

            // --- NUEVOS ESTADOS PARA MODO TRANSFERENCIA ---
            const [isTransferMode, setIsTransferMode] = useState(false);
            const [transferSelection, setTransferSelection] = useState(new Set());

            const [modalState, setModalState] = useState({ isOpen: false, type: null, title: '', message: '', onConfirm: null });
            const [observationModal, setObservationModal] = useState({ isOpen: false, text: '' });
            const [reprintModal, setReprintModal] = useState({ isOpen: false, pdfUrl: null, printablePdfUrl: null, palletId: null });
            const [activeActionMenu, setActiveActionMenu] = useState(null);
            const [activeClientMenu, setActiveClientMenu] = useState({rowId: null, client: null});
            const actionMenuRef = useRef(null);
            const clientMenuRef = useRef(null);
            
            const [columnFilters, setColumnFilters] = useLocalStorage('grillaqr_columnFilters_v5', {
                sku: '',
                descripcion: '',
                numeroDePallet: '',
                lotesProduccion: '',
                transferido: '', // CAMBIO DE NOMBRE Y LOGICA
                despachado: '',
                cliente: ''
            });
            const [fechaDesde, setFechaDesde] = useLocalStorage('grillaqr_fechaDesde', '');
            const [fechaHasta, setFechaHasta] = useLocalStorage('grillaqr_fechaHasta', '');
            
            const [isExportOpen, setIsExportOpen] = useState(false);
            const exportMenuRef = useRef(null);

            const getApiToken = async (file) => {
                try {
                    const response = await fetch(file + '?t=' + new Date().getTime());
                    if (!response.ok) throw new Error(`No se pudo cargar ${file}.`);
                    let rawText = await response.text();
                    return rawText.replace(/aaaa/g, '').replace(/bbbb/g, '').replace(/cccc/g, '').trim();
                } catch (error) {
                    console.error(`Error al obtener ${file}:`, error);
                    return null;
                }
            };

            const fetchCsvFromGithub = useCallback(async (path) => {
                const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}?t=${new Date().getTime()}`;
                try {
                    const headers = apiToken ? { 'Authorization': `token ${apiToken}` } : {};
                    const response = await fetch(url, { headers, cache: 'no-store' });
                    if (response.status === 404) return [];
                    if (!response.ok) throw new Error(`No se pudo cargar ${path} (Estado: ${response.status})`);
                    const fileData = await response.json();
                    return atob(fileData.content).split('\n').filter(Boolean);
                } catch (error) {
                    console.error(`Error cargando ${path}:`, error);
                    alert(`Error al cargar datos desde GitHub: ${error.message}`);
                    return [];
                }
            }, [apiToken]);

            const loadData = useCallback(async () => {
                setIsLoading(true);
                // Salir del modo transferencia al recargar
                setIsTransferMode(false);
                setTransferSelection(new Set());

                const [lotesRows, notasRows, almacenadosRows] = await Promise.all([
                    fetchCsvFromGithub(CSV_PATH_LOTES),
                    fetchCsvFromGithub(CSV_PATH_NOTAS),
                    fetchCsvFromGithub(CSV_PATH_ALMACENADOS)
                ]);

                const almacenadosSet = new Set(almacenadosRows);

                const notesMap = new Map();
                notasRows.forEach(row => {
                    const [sku, numeroDePallet, observacion] = row.split(';');
                    notesMap.set(`${sku};${numeroDePallet}`, observacion);
                });

                const parsedLotes = lotesRows.map((row, index) => {
                    const [sku, descripcion, numeroDePallet, lotesProduccion, fechaProduccion, cantidad, unidadMedida, despachado, cliente] = row.split(';');
                    const key = `${sku};${numeroDePallet}`;
                    const hasNote = notesMap.has(key);
                    const noteText = hasNote ? notesMap.get(key) : '';
                    const isTransferido = almacenadosSet.has(key);
                    return { id: index, sku, descripcion, numeroDePallet, lotesProduccion, fechaProduccion, cantidad, unidadMedida, despachado, cliente, hasNote, noteText, isTransferido };
                });
                
                setAllData(parsedLotes);
                setIsLoading(false);
            }, [fetchCsvFromGithub]);
            
            const saveCsvToGithub = async (path, content, message, isAppend = false) => {
                if (!apiToken) {
                    alert("Error: El token de API no está disponible.");
                    return { success: false, message: "Token no disponible." };
                }
                const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`;
                try {
                    const fileResponse = await fetch(url, { headers: { 'Authorization': `token ${apiToken}` } });
                    let currentSha = null;
                    let currentContent = '';
                    if (fileResponse.ok) {
                        const fileData = await fileResponse.json();
                        currentSha = fileData.sha;
                        if (isAppend) currentContent = atob(fileData.content);
                    } else if (fileResponse.status !== 404) throw new Error(`Error ${fileResponse.status}`);
                    
                    const finalContent = isAppend ? `${currentContent.trim()}\n${content.trim()}`.trim() : content;
                    
                    const updateResponse = await fetch(url, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${apiToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message, content: btoa(unescape(encodeURIComponent(finalContent))), sha: currentSha }),
                    });

                    if (!updateResponse.ok) throw new Error(`Error ${updateResponse.status}`);
                    return { success: true };
                } catch (e) {
                    alert(`ERROR al guardar ${path} en GitHub: ${e.message}`);
                    return { success: false, message: e.message };
                }
            };
            
            const verifyPasswordAndExecute = async (actionCallback, password) => {
                if (!password) {
                    alert("Por favor, ingrese la contraseña.");
                    return;
                }
                const correctPassword = await getApiToken('pswsku.txt');
                if (password.trim() === correctPassword) {
                    setAuthTimestamp(Date.now());
                    setModalState({ isOpen: false });
                    actionCallback();
                } else {
                    alert("Contraseña incorrecta.");
                }
            };

            const executeActionWithAuth = (actionCallback) => {
                const now = Date.now();
                if (authTimestamp && (now - authTimestamp < AUTH_TIMEOUT)) {
                    actionCallback();
                } else {
                    setModalState({
                        isOpen: true,
                        type: 'password',
                        title: 'Autorización Requerida',
                        message: 'Por seguridad, ingrese la contraseña de administrador para continuar.',
                        onConfirm: (password) => verifyPasswordAndExecute(actionCallback, password)
                    });
                }
            };
            
            useEffect(() => {
                const initializeApp = async () => {
                    const loaderStatus = document.getElementById('loader-status');
                    const loaderProgress = document.getElementById('loader-progress');
                    if(loaderStatus) loaderStatus.textContent = "Verificando acceso...";
                    if(loaderProgress) loaderProgress.style.width = '20%';
                    const token = await getApiToken('cls.txt');
                    setApiToken(token); 

                    if(loaderStatus) loaderStatus.textContent = "Cargando lista de clientes...";
                    if(loaderProgress) loaderProgress.style.width = '40%';
                    try {
                        const clientResponse = await fetch('clientes.txt?t=' + new Date().getTime());
                        const clientText = await clientResponse.text();
                        setClientList(clientText.split('\n').map(c => c.trim().toUpperCase()).filter(Boolean));
                    } catch (e) { console.error("No se pudo cargar la lista de clientes."); }
                    
                    if(loaderStatus) loaderStatus.textContent = "Cargando descripciones de artículos...";
                    if(loaderProgress) loaderProgress.style.width = '60%';
                    try {
                        const articulosResponse = await fetch('articulos.csv?t=' + new Date().getTime());
                        const articulosText = await articulosResponse.text();
                        const newArticulosMap = new Map();
                        articulosText.split('\n').slice(1).forEach(row => {
                            const [tipo, sku, descLarga, descCorta] = row.split(';');
                            if (sku && descCorta) {
                                newArticulosMap.set(sku.trim(), descCorta.trim());
                            }
                        });
                        setArticulosMap(newArticulosMap);
                    } catch (e) {
                        console.error("No se pudo cargar la lista de artículos.");
                    }
                };
                initializeApp();
            }, []);

            useEffect(() => {
                if(apiToken) {
                    const loadInitialData = async () => {
                        const loaderStatus = document.getElementById('loader-status');
                        const loaderProgress = document.getElementById('loader-progress');
                        const staticLoader = document.getElementById('static-loader');

                        if (loaderStatus) loaderStatus.textContent = "Cargando histórico y notas...";
                        if (loaderProgress) loaderProgress.style.width = '80%';
                        
                        await loadData();
                        
                        if (!fechaDesde && !fechaHasta) {
                            const today = new Date();
                            const firstDayOfLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                            const todayISO = today.toISOString().split('T')[0];
                            const lastMonthISO = firstDayOfLastMonth.toISOString().split('T')[0];
                            setFechaHasta(todayISO);
                            setFechaDesde(lastMonthISO);
                        }
                        
                        if (loaderStatus) loaderStatus.textContent = "¡Listo!";
                        if (loaderProgress) loaderProgress.style.width = '100%';
                        
                        setTimeout(() => {
                             if (staticLoader) {
                                staticLoader.classList.add('opacity-0');
                                setTimeout(() => staticLoader.remove(), 500);
                            }
                        }, 500);
                    };
                    loadInitialData();
                }
            }, [apiToken, loadData]);

            useEffect(() => {
                // Cualquier cambio en los filtros principales cancela el modo transferencia
                if (isTransferMode) {
                    setIsTransferMode(false);
                    setTransferSelection(new Set());
                }

                let data = [...allData];

                // Filtro especial para el modo transferencia
                if (isTransferMode) {
                    data = data.filter(item => !item.isTransferido);
                } else {
                    // Lógica de filtrado normal
                    Object.keys(columnFilters).forEach(key => {
                        const filterValue = columnFilters[key].toLowerCase();
                        if (filterValue) {
                            data = data.filter(item => {
                                if (key === 'despachado') {
                                    const despachadoText = (item.despachado && item.despachado.toUpperCase() === 'TRUE') ? 'sí' : 'no';
                                    return despachadoText.includes(filterValue);
                                }
                                if (key === 'transferido') {
                                    const transferidoText = item.isTransferido ? 'sí' : 'no';
                                    return transferidoText.includes(filterValue);
                                }
                                if (key === 'numeroDePallet' && item.hasNote) {
                                    const palletWithAsterisk = `${item.numeroDePallet} (*)`
                                    return palletWithAsterisk.toLowerCase().includes(filterValue) || (item[key] && item[key].toString().toLowerCase().includes(filterValue));
                                }
                                return item[key] && item[key].toString().toLowerCase().includes(filterValue);
                            });
                        }
                    });
                
                    if (fechaDesde || fechaHasta) {
                        const desde = fechaDesde ? new Date(fechaDesde) : null;
                        const hasta = fechaHasta ? new Date(fechaHasta) : null;
                        if(desde) desde.setMinutes(desde.getMinutes() + desde.getTimezoneOffset());
                        if(hasta) hasta.setMinutes(hasta.getMinutes() + hasta.getTimezoneOffset());
                        data = data.filter(item => {
                            if (!item.fechaProduccion) return false;
                            const [day, month, year] = item.fechaProduccion.split('/');
                            if (!day || !month || !year) return false;
                            const itemDate = new Date(year, month - 1, day);
                            return (!desde || itemDate >= desde) && (!hasta || itemDate <= hasta);
                        });
                    }
                }
                setFilteredData(data);
            }, [columnFilters, fechaDesde, fechaHasta, allData, isTransferMode]);
            
            const handleColumnFilterChange = (columnId, value) => {
                setIsTransferMode(false); // Salir del modo transferencia si se filtra
                setColumnFilters(prev => ({ ...prev, [columnId]: value }));
            };

            const clearFilters = () => {
                setIsTransferMode(false);
                setColumnFilters({ sku: '', descripcion: '', numeroDePallet: '', lotesProduccion: '', transferido: '', despachado: '', cliente: '' });
                setFechaDesde('');
                setFechaHasta('');
            };

            // --- INICIO: LÓGICA DE TRANSFERENCIA ---
            const handleEnterTransferMode = () => {
                const pendientes = allData.filter(item => !item.isTransferido);
                if (pendientes.length === 0) {
                    alert("No hay pallets pendientes de transferir.");
                    return;
                }
                setIsTransferMode(true);
                setTransferSelection(new Set());
                // Limpiar filtros de columna para evitar confusiones
                setColumnFilters({ sku: '', descripcion: '', numeroDePallet: '', lotesProduccion: '', transferido: '', despachado: '', cliente: '' });
            };

            const handleCancelTransferMode = () => {
                setIsTransferMode(false);
                setTransferSelection(new Set());
            };

            const handleTransferSelectionChange = (itemId) => {
                setTransferSelection(prevSelection => {
                    const newSelection = new Set(prevSelection);
                    if (newSelection.has(itemId)) {
                        newSelection.delete(itemId);
                    } else {
                        newSelection.add(itemId);
                    }
                    return newSelection;
                });
            };

            const handleConfirmTransfer = () => {
                if (transferSelection.size === 0) {
                    alert("Por favor, seleccione al menos un pallet para transferir.");
                    return;
                }

                const itemsToTransfer = allData.filter(item => transferSelection.has(item.id));
                const message = `Se transferirán ${itemsToTransfer.length} pallets. ¿Desea continuar?`;

                setModalState({
                    isOpen: true,
                    type: 'confirm',
                    title: 'Confirmar Transferencia',
                    message: message,
                    onConfirm: () => {
                        setModalState({ isOpen: false });
                        executeActionWithAuth(async () => {
                            setIsSaving(true);
                            
                            // 1. Generar PDF
                            generateTransferPDF(itemsToTransfer);

                            // 2. Actualizar archivo
                            const nuevosAlmacenados = itemsToTransfer.map(item => `${item.sku};${item.numeroDePallet}`).join('\n');
                            const result = await saveCsvToGithub(CSV_PATH_ALMACENADOS, nuevosAlmacenados, "Registra pallets transferidos", true);

                            setIsSaving(false);

                            // 3. Recargar y salir del modo
                            if (result.success) {
                                alert(`¡Operación completada! Se transfirieron ${itemsToTransfer.length} pallets y el reporte se ha descargado.`);
                                await loadData(); // Esto ya resetea el modo transferencia
                            } else {
                                alert("Ocurrió un error al actualizar el estado de los pallets.");
                            }
                        });
                    }
                });
            };

            const generateTransferPDF = (items) => {
                const doc = new jsPDF({ orientation: 'landscape' });
                doc.setFontSize(18);
                doc.text("Reporte de Transferencia a Logística", 14, 16);
                doc.setFontSize(10);
                doc.text(`Fecha de generación: ${new Date().toLocaleString('es-AR')}`, 14, 22);

                // Tabla de Detalle
                doc.setFontSize(14);
                doc.text("Detalle de Pallets a Transferir", 14, 32);
                const detailColumns = ["SKU", "Descripción", "Nº Pallet", "Lotes Prod.", "F. Prod.", "Cantidad", "U.M."];
                const detailRows = items.map(item => [item.sku, item.descripcion, item.numeroDePallet, item.lotesProduccion, item.fechaProduccion, item.cantidad, item.unidadMedida]);
                doc.autoTable({ head: [detailColumns], body: detailRows, startY: 36, theme: 'grid' });

                // Tabla de Resumen
                const summary = items.reduce((acc, item) => {
                    const qty = parseFloat(item.cantidad.replace(',', '.')) || 0;
                    if (!acc[item.sku]) {
                        acc[item.sku] = {
                            descripcion: item.descripcion,
                            cantidadTotal: 0,
                            unidadMedida: item.unidadMedida
                        };
                    }
                    acc[item.sku].cantidadTotal += qty;
                    return acc;
                }, {});

                const summaryColumns = ["SKU", "Descripción", "Cantidad Total", "U.M."];
                const summaryRows = Object.entries(summary).map(([sku, data]) => [
                    sku,
                    data.descripcion,
                    data.cantidadTotal.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
                    data.unidadMedida
                ]);

                doc.setFontSize(14);
                doc.text("Resumen por Producto", 14, doc.autoTable.previous.finalY + 12);
                doc.autoTable({ head: [summaryColumns], body: summaryRows, startY: doc.autoTable.previous.finalY + 16, theme: 'grid' });

                doc.save("reporte_transferencia.pdf");
            };
            // --- FIN: LÓGICA DE TRANSFERENCIA ---

            return (
                <div className="min-h-screen p-4 sm:p-6 bg-black bg-opacity-50">
                    {isSaving && (
                        <div className="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
                            <div className="flex items-center space-x-3 text-xl font-semibold text-gray-700"><i className="fas fa-sync-alt animate-spin"></i><span>Guardando y procesando...</span></div>
                        </div>
                    )}
                    <ActionModal isOpen={modalState.isOpen} type={modalState.type} title={modalState.title} message={modalState.message} onClose={() => setModalState({ isOpen: false })} onConfirm={modalState.onConfirm} suggestions={clientList}/>
                    
                    <div className="bg-white p-6 rounded-2xl shadow-xl">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4 border-gray-200">
                            <div className="flex items-center space-x-4">
                                <h1 className="text-3xl font-extrabold text-gray-800">Histórico de Lotes</h1>
                            </div>
                            <div className="flex items-center space-x-3 mt-4 sm:mt-0">
                                {isTransferMode ? (
                                    <>
                                        <button onClick={handleConfirmTransfer} className="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-sm flex items-center"><i className="fas fa-check-circle mr-2"></i>Confirmar Almacenamiento</button>
                                        <button onClick={handleCancelTransferMode} className="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors shadow-sm flex items-center"><i className="fas fa-times-circle mr-2"></i>Cancelar</button>
                                    </>
                                ) : (
                                    <>
                                        <button onClick={handleEnterTransferMode} className="bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors shadow-sm flex items-center"><i className="fas fa-truck-loading mr-2"></i>Pendientes de Transferir</button>
                                        <a href="generarqr.html" className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-sm flex items-center"><i className="fas fa-plus mr-2"></i>Generar Nuevo</a>
                                        <a href="index.html" className="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Volver al Menú</a>
                                    </>
                                )}
                            </div>
                        </div>
                        
                        {!isTransferMode && (
                            <div className="mb-6 p-4 border rounded-lg bg-gray-50 space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Fecha Desde</label>
                                        <input type="date" value={fechaDesde} onChange={e => setFechaDesde(e.target.value)} className="w-full rounded-md border-gray-300 shadow-sm p-2 border"/>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Fecha Hasta</label>
                                        <input type="date" value={fechaHasta} onChange={e => setFechaHasta(e.target.value)} className="w-full rounded-md border-gray-300 shadow-sm p-2 border"/>
                                    </div>
                                    <div className="flex items-end">
                                        <button onClick={clearFilters} className="w-full bg-white text-gray-700 border border-gray-300 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-50 flex items-center justify-center"><i className="fas fa-times-circle mr-2"></i>Limpiar Filtros</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="flex flex-col sm:flex-row justify-between items-center mb-4">
                            <p className="text-gray-600 font-semibold">{filteredData.length} registro(s) encontrado(s)</p>
                            <div className="flex space-x-2 mt-4 sm:mt-0">
                                <button onClick={loadData} disabled={isLoading || isSaving} className="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 disabled:opacity-50 flex items-center"><i className={`fas fa-sync-alt ${isLoading ? 'animate-spin' : ''} mr-2`}></i>Refrescar</button>
                            </div>
                        </div>

                        <div className="overflow-x-auto rounded-lg shadow-md border pb-40" style={{ maxHeight: '60vh' }}>
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-800 text-white sticky top-0 z-10">
                                    <tr>
                                        {["SKU", "Descripción", "Nº Pallet", "Lotes Prod.", "TRANSFERIDO", "Despachado", "Cliente", "F. Prod.", "Cantidad", "U.M.", "Acciones"].map(header => (
                                            <th key={header} className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">{header}</th>
                                        ))}
                                    </tr>
                                    {!isTransferMode && (
                                    <tr className="bg-gray-200">
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.sku} onChange={e => handleColumnFilterChange('sku', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.descripcion} onChange={e => handleColumnFilterChange('descripcion', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.numeroDePallet} onChange={e => handleColumnFilterChange('numeroDePallet', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.lotesProduccion} onChange={e => handleColumnFilterChange('lotesProduccion', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Sí / No" value={columnFilters.transferido} onChange={e => handleColumnFilterChange('transferido', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Sí / No" value={columnFilters.despachado} onChange={e => handleColumnFilterChange('despachado', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.cliente} onChange={e => handleColumnFilterChange('cliente', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th colSpan="4" className="p-1"></th>
                                    </tr>
                                    )}
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {isLoading ? (
                                        <tr><td colSpan="11" className="p-8 text-center text-gray-500">Cargando datos...</td></tr>
                                    ) : (
                                        filteredData.length > 0 ? filteredData.map((item) => {
                                            const isDespachado = item.despachado && item.despachado.toUpperCase() === 'TRUE';
                                            return (
                                            <tr key={item.id} className={item.hasNote ? 'bg-yellow-50 hover:bg-yellow-100' : 'hover:bg-gray-50'}>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">{item.sku}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.descripcion}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600 font-semibold">
                                                    {item.numeroDePallet}
                                                    {item.hasNote && <span className="text-red-500 ml-1 cursor-pointer" onClick={() => setObservationModal({ isOpen: true, text: item.noteText })}>(*)</span>}
                                                </td>
                                                <td className="px-4 py-2 text-sm text-gray-600 align-middle">
                                                    {item.lotesProduccion && item.lotesProduccion.includes('#') ? (
                                                        <div className="flex flex-wrap gap-1">
                                                            {item.lotesProduccion.split('#').map((lote, i) => (<span key={`${lote}-${i}`} className="px-2.5 py-0.5 text-xs font-semibold bg-gray-100 text-gray-800 rounded-full">{lote}</span>))}
                                                        </div>
                                                    ) : ( item.lotesProduccion )}
                                                </td>
                                                <td className="px-4 py-2 whitespace-nowrap text-center">
                                                    <input 
                                                        type="checkbox"
                                                        className="h-5 w-5 rounded border-gray-300 text-green-600 focus:ring-green-500 checkbox-accent disabled:opacity-50"
                                                        checked={item.isTransferido || transferSelection.has(item.id)}
                                                        disabled={item.isTransferido || !isTransferMode}
                                                        onChange={() => handleTransferSelectionChange(item.id)}
                                                    />
                                                </td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm font-semibold"><span className={isDespachado ? 'text-green-600' : 'text-red-600'}>{isDespachado ? 'Sí' : 'No'}</span></td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.cliente ? item.cliente.replace(/#/g, ', ') : ''}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.fechaProduccion}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.cantidad}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.unidadMedida}</td>
                                                <td className="px-4 py-2 text-center">
                                                    <div className="relative">
                                                        <button onClick={() => setActiveActionMenu(activeActionMenu === item.id ? null : item.id)} className="text-gray-500 hover:text-blue-600 p-2 rounded-full"><i className="fas fa-ellipsis-v"></i></button>
                                                        {activeActionMenu === item.id && (
                                                            <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border z-30">
                                                                {/* Opciones de menú de acción */}
                                                            </div>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                            )
                                        }) : (
                                            <tr><td colSpan="11" className="px-4 py-8 text-center text-sm text-gray-500">No se encontraron registros.</td></tr>
                                        )
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
