<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLDERIL - Histórico de Lotes (Sincronizado)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
          background-image: url('fondo.jpg');
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
          background-attachment: fixed;
        }
        .backdrop-blur-lg {
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }
        /* Animación para modales */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in {
            animation: fadeIn 0.2s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Cargador inicial estático -->
    <div id="static-loader" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 p-4 font-sans z-50">
        <div class="relative bg-[#D2B48C]/20 backdrop-blur-lg border border-[#D2B48C]/30 p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
          <img src="logo.jpg" alt="Logo Molderil" class="mx-auto mb-6 h-32 [filter:drop-shadow(2px_2px_4px_rgba(0,0,0,0.4))_drop-shadow(-2px_-2px_4px_rgba(255,255,255,0.6))]"/>
          <p id="loader-status" class="text-xl text-white mb-4 [text-shadow:_1px_1px_2px_rgba(0,0,0,0.5)]">Cargando aplicación...</p>
          <div class="w-full bg-white/20 rounded-full h-4 border border-white/30">
            <div id="loader-progress" class="bg-amber-400 h-full rounded-full transition-all duration-500" style="width: 10%"></div>
          </div>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const { createRoot } = ReactDOM;
        const { jsPDF } = window.jspdf;

        // --- CONFIGURACIÓN DE GITHUB ---
        const GITHUB_USER = 'gagegfg';
        const GITHUB_REPO = 'Molderil_ListaEmpaque';
        const CSV_PATH_LOTES = 'detallelotes.csv';
        const CSV_PATH_NOTAS = 'notasskulote.csv';
        const CSV_PATH_ALMACENADOS = 'nropalletalmacenado.csv';
        const AUTH_TIMEOUT = 5 * 60 * 1000; // 5 minutos

        // --- COMPONENTES Y LÓGICA DE LA APLICACIÓN ---
        const App = () => {
            // Estados principales
            const [allData, setAllData] = useState([]);
            const [filteredData, setFilteredData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [apiToken, setApiToken] = useState(null);
            
            // Estados para el flujo de transferencia
            const [isTransferMode, setIsTransferMode] = useState(false);
            const [selectedForTransfer, setSelectedForTransfer] = useState(new Set());

            // Estados para filtros y UI
            const [columnFilters, setColumnFilters] = useState({ sku: '', descripcion: '', numeroDePallet: '', lotesProduccion: '', despachado: '', cliente: '' });
            const [fechaDesde, setFechaDesde] = useState('');
            const [fechaHasta, setFechaHasta] = useState('');
            
            // Estados de modales y menús
            const [modalState, setModalState] = useState({ isOpen: false, type: null, title: '', message: '', onConfirm: null });
            const [reprintModal, setReprintModal] = useState({ isOpen: false, pdfUrl: null, printablePdfUrl: null, palletId: null });
            const [showHelpModal, setShowHelpModal] = useState(false);
            const [activeActionMenu, setActiveActionMenu] = useState(null);
            
            // Referencias a elementos del DOM
            const actionMenuRef = useRef(null);
            const exportMenuRef = useRef(null);
            const [isExportOpen, setIsExportOpen] = useState(false);

            // --- FUNCIONES DE API Y MANEJO DE DATOS ---

            // Obtiene un token o contraseña desde un archivo de texto
            const getApiToken = async (file) => {
                try {
                    const response = await fetch(`${file}?t=${new Date().getTime()}`);
                    if (!response.ok) throw new Error(`No se pudo cargar ${file}.`);
                    return (await response.text()).replace(/aaaa|bbbb|cccc/g, '').trim();
                } catch (error) {
                    console.error(`Error al obtener ${file}:`, error);
                    return null;
                }
            };

            // Obtiene el contenido de un archivo CSV desde GitHub
            const fetchCsvFromGithub = useCallback(async (path) => {
                const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}?t=${new Date().getTime()}`;
                try {
                    const headers = apiToken ? { 'Authorization': `token ${apiToken}` } : {};
                    const response = await fetch(url, { headers, cache: 'no-store' });
                    if (response.status === 404) return []; // Si no existe, devuelve array vacío
                    if (!response.ok) throw new Error(`Error ${response.status}`);
                    const fileData = await response.json();
                    return atob(fileData.content).split('\n').filter(Boolean);
                } catch (error) {
                    console.error(`Error cargando ${path}:`, error);
                    alert(`Error al cargar datos desde GitHub: ${error.message}.`);
                    return [];
                }
            }, [apiToken]);

            // Carga todos los datos iniciales de los archivos CSV
            const loadData = useCallback(async () => {
                setIsLoading(true);
                resetTransferMode(); // Resetea el modo transferencia al recargar
                const [lotesRows, notasRows, almacenadosRows] = await Promise.all([
                    fetchCsvFromGithub(CSV_PATH_LOTES),
                    fetchCsvFromGithub(CSV_PATH_NOTAS),
                    fetchCsvFromGithub(CSV_PATH_ALMACENADOS)
                ]);

                const storedPallets = new Set(almacenadosRows);
                const notesMap = new Map(notasRows.map(row => {
                    const [sku, numeroDePallet, observacion] = row.split(';');
                    return [`${sku};${numeroDePallet}`, observacion];
                }));

                const parsedLotes = lotesRows.map((row, index) => {
                    const [sku, descripcion, numeroDePallet, lotesProduccion, fechaProduccion, cantidad, unidadMedida, despachado, cliente] = row.split(';');
                    const palletKey = `${sku};${numeroDePallet}`;
                    return { 
                        id: index, sku, descripcion, numeroDePallet, lotesProduccion, fechaProduccion, cantidad, unidadMedida, despachado, cliente,
                        hasNote: notesMap.has(palletKey),
                        noteText: notesMap.get(palletKey) || '',
                        isTransferred: storedPallets.has(palletKey)
                    };
                });
                
                setAllData(parsedLotes);
                setIsLoading(false);
            }, [fetchCsvFromGithub]);
            
            // Añade líneas a un archivo CSV en GitHub sin sobreescribir
            const appendDataToGithub = async (path, linesToAppend) => {
                if (!apiToken || linesToAppend.length === 0) return { success: true };
                setIsSaving(true);
                const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`;
                try {
                    let currentContent = '';
                    let currentSha = null;
                    const fileResponse = await fetch(url, { headers: { 'Authorization': `token ${apiToken}` }, cache: 'no-store' });
                    if (fileResponse.ok) {
                        const fileData = await fileResponse.json();
                        currentSha = fileData.sha;
                        currentContent = atob(fileData.content);
                    } else if (fileResponse.status !== 404) throw new Error(`Error ${fileResponse.status}`);

                    const newContent = (currentContent ? `${currentContent}\n` : '') + linesToAppend.join('\n');
                    
                    const updateResponse = await fetch(url, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${apiToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: `Añadir datos a ${path}`, content: btoa(unescape(encodeURIComponent(newContent))), sha: currentSha }),
                    });
                    if (!updateResponse.ok) throw new Error(`Error ${updateResponse.status}`);
                    return { success: true };
                } catch (e) {
                    alert(`ERROR al añadir a ${path} en GitHub: ${e.message}`);
                    return { success: false };
                } finally {
                    setIsSaving(false);
                }
            };

            // --- LÓGICA DE FILTRADO Y EFECTOS ---
            
            useEffect(() => {
                // Efecto de inicialización de la aplicación
                const initializeApp = async () => {
                    document.getElementById('loader-status').textContent = "Verificando acceso...";
                    document.getElementById('loader-progress').style.width = '33%';
                    const token = await getApiToken('cls.txt');
                    setApiToken(token); 
                };
                initializeApp();
            }, []);

            useEffect(() => {
                // Efecto para cargar datos cuando el token está listo
                if(apiToken) {
                    const loadInitialData = async () => {
                        document.getElementById('loader-status').textContent = "Cargando datos de la grilla...";
                        document.getElementById('loader-progress').style.width = '66%';
                        await loadData();
                        
                        document.getElementById('loader-status').textContent = "¡Listo!";
                        document.getElementById('loader-progress').style.width = '100%';
                        
                        setTimeout(() => {
                            const staticLoader = document.getElementById('static-loader');
                            if (staticLoader) {
                                staticLoader.classList.add('opacity-0');
                                setTimeout(() => staticLoader.remove(), 500);
                            }
                        }, 500);
                    };
                    loadInitialData();
                }
            }, [apiToken, loadData]);

            useEffect(() => {
                // Efecto para aplicar filtros a los datos
                let data = [...allData];

                if (isTransferMode) {
                    data = data.filter(item => !item.isTransferred);
                }

                // Filtros de columna
                Object.keys(columnFilters).forEach(key => {
                    const filterValue = columnFilters[key].toLowerCase();
                    if (filterValue) {
                        data = data.filter(item => item[key]?.toString().toLowerCase().includes(filterValue));
                    }
                });
                
                // Filtros de fecha
                if (fechaDesde || fechaHasta) {
                    const desde = fechaDesde ? new Date(`${fechaDesde}T00:00:00`) : null;
                    const hasta = fechaHasta ? new Date(`${fechaHasta}T23:59:59`) : null;
                    data = data.filter(item => {
                        if (!item.fechaProduccion) return false;
                        const [day, month, year] = item.fechaProduccion.split('/');
                        const itemDate = new Date(year, month - 1, day);
                        return (!desde || itemDate >= desde) && (!hasta || itemDate <= hasta);
                    });
                }
                setFilteredData(data);
            }, [columnFilters, fechaDesde, fechaHasta, allData, isTransferMode]);
            
            useEffect(() => {
                // Efecto para cerrar menús al hacer clic fuera
                const handleClickOutside = (event) => {
                    if (exportMenuRef.current && !exportMenuRef.current.contains(event.target)) setIsExportOpen(false);
                    if (actionMenuRef.current && !actionMenuRef.current.parentElement.contains(event.target)) setActiveActionMenu(null);
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            // --- MANEJADORES DE EVENTOS Y ACCIONES ---

            const resetTransferMode = () => {
                setIsTransferMode(false);
                setSelectedForTransfer(new Set());
            };

            const handleColumnFilterChange = (columnId, value) => {
                resetTransferMode();
                setColumnFilters(prev => ({ ...prev, [columnId]: value }));
            };
            
            const handleDateChange = (setter, value) => {
                resetTransferMode();
                setter(value);
            };

            const clearFilters = () => {
                resetTransferMode();
                setColumnFilters({ sku: '', descripcion: '', numeroDePallet: '', lotesProduccion: '', despachado: '', cliente: '' });
                setFechaDesde('');
                setFechaHasta('');
            };

            const handleReprint = async (item) => {
                // Lógica para generar y mostrar el PDF de reimpresión
                const qrString = [ item.sku, item.descripcion, item.numeroDePallet, item.lotesProduccion, item.fechaProduccion, item.cantidad.replace(',', '.'), item.unidadMedida ].join(';');
                const doc = new jsPDF('p', 'mm', 'a4');
                const qrImageData = await QRCode.toDataURL(qrString, { width: 400, margin: 2 });
                
                // (Aquí iría el diseño detallado de la etiqueta como en tu código original)
                doc.setFontSize(20);
                doc.text(`Etiqueta Pallet: ${item.numeroDePallet}`, 10, 20);
                doc.text(`SKU: ${item.sku}`, 10, 30);
                doc.addImage(qrImageData, 'PNG', 10, 40, 80, 80);

                const previewUrl = doc.output('datauristring');
                doc.autoPrint();
                const printableUrl = doc.output('bloburl');

                setReprintModal({ isOpen: true, pdfUrl: previewUrl, printablePdfUrl: printableUrl, palletId: item.numeroDePallet });
            };

            // --- LÓGICA DEL FLUJO DE TRANSFERENCIA ---

            const handlePendientesClick = () => setIsTransferMode(true);
            
            const handleTransferSelection = (itemId) => {
                const newSelection = new Set(selectedForTransfer);
                if (newSelection.has(itemId)) newSelection.delete(itemId);
                else newSelection.add(itemId);
                setSelectedForTransfer(newSelection);
            };
            
            const generateTransferPDF = (selectedItems) => {
                const doc = new jsPDF();
                doc.setFontSize(18); doc.text("Reporte de Transferencia a Logística", 14, 22);
                
                // Tabla de Detalle
                doc.autoTable({
                    startY: 30,
                    head: [["SKU", "Descripción", "Nº Pallet", "Cantidad", "UM"]],
                    body: selectedItems.map(item => [item.sku, item.descripcion, item.numeroDePallet, item.cantidad, item.unidadMedida]),
                    theme: 'grid'
                });

                // Tabla de Resumen
                const summary = selectedItems.reduce((acc, item) => {
                    const cant = parseFloat(item.cantidad.replace('.', '').replace(',', '.'));
                    if (!acc[item.sku]) {
                        acc[item.sku] = { desc: item.descripcion, total: 0, um: item.unidadMedida };
                    }
                    acc[item.sku].total += isNaN(cant) ? 0 : cant;
                    return acc;
                }, {});
                
                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 10,
                    head: [["SKU", "Descripción", "Cantidad Total", "UM"]],
                    body: Object.entries(summary).map(([sku, data]) => [sku, data.desc, data.total.toLocaleString('es-AR'), data.um]),
                    theme: 'grid'
                });

                doc.autoPrint();
                window.open(doc.output('bloburl'), '_blank');
            };

            const handleConfirmarAlmacenamiento = async () => {
                if (selectedForTransfer.size === 0) {
                    alert("No ha seleccionado ningún pallet para transferir.");
                    return;
                }
                if (!window.confirm(`¿Desea confirmar la transferencia de los ${selectedForTransfer.size} pallets seleccionados?`)) {
                    return;
                }

                const selectedItems = allData.filter(item => selectedForTransfer.has(item.id));
                
                // 1. Generar PDF
                generateTransferPDF(selectedItems);

                // 2. Actualizar CSV
                const linesToAppend = selectedItems.map(item => `${item.sku};${item.numeroDePallet}`);
                const result = await appendDataToGithub(CSV_PATH_ALMACENADOS, linesToAppend);

                // 3. Finalizar y Refrescar
                if (result.success) {
                    alert("Proceso de transferencia completado con éxito.");
                    await loadData(); // Esto ya resetea el modo transferencia
                } else {
                    alert("El proceso de transferencia falló. Por favor, revise la consola y reintente.");
                }
            };

            // --- COMPONENTES DE MODALES ---

            const ActionModal = ({ isOpen, title, message, onClose, onConfirm }) => { /* ... (Implementación si se necesita) ... */ };
            
            const ReprintModal = ({ isOpen, pdfUrl, printablePdfUrl, palletId, onClose }) => {
                if (!isOpen) return null;
                return (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                        <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-2xl h-5/6 flex flex-col animate-fade-in">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Reimprimir Etiqueta - Pallet Nº {palletId}</h3>
                            <div className="flex-grow border rounded-lg overflow-hidden">
                                <iframe src={pdfUrl} className="w-full h-full" title={`Etiqueta Pallet ${palletId}`}></iframe>
                            </div>
                            <div className="flex justify-end space-x-3 mt-6">
                                <button onClick={onClose} className="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                                <button onClick={() => window.open(printablePdfUrl, '_blank')} className="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center"><i className="fas fa-print mr-2"></i>Imprimir</button>
                            </div>
                        </div>
                    </div>
                );
            };
            
            const HelpModal = ({ isOpen, onClose }) => {
                if (!isOpen) return null;
                return (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                        <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-lg animate-fade-in">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Ayuda y Referencia Rápida</h3>
                            <div className="text-sm text-gray-700 space-y-3 border-t pt-4">
                                <p><strong className="text-indigo-600">Ver Observaciones:</strong> Si una fila está amarilla, tiene una nota. Haz <strong>doble clic</strong> (o <strong>pulsación larga</strong> en móvil) para leerla.</p>
                                <p><strong className="text-indigo-600">Modo Transferencia:</strong> Usa <strong>"Pendientes por Almacenar"</strong> para filtrar y seleccionar pallets. Las demás acciones se desactivan en este modo. Para salir, refresca la página o limpia los filtros.</p>
                                <p><strong className="text-indigo-600">Menú de Acciones (...):</strong> Permite <strong>Reimprimir Etiquetas</strong> y otras gestiones de fila (si se implementan).</p>
                            </div>
                            <div className="flex justify-end mt-6">
                                <button onClick={onClose} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Entendido</button>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- RENDERIZADO DEL COMPONENTE PRINCIPAL ---
            return (
                <div className="min-h-screen p-4 sm:p-6 bg-black bg-opacity-50">
                    {isSaving && ( <div className="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50"><div className="flex items-center space-x-3 text-xl"><i className="fas fa-sync-alt animate-spin"></i><span>Guardando...</span></div></div> )}
                    <ReprintModal isOpen={reprintModal.isOpen} pdfUrl={reprintModal.pdfUrl} printablePdfUrl={reprintModal.printablePdfUrl} palletId={reprintModal.palletId} onClose={() => setReprintModal({ isOpen: false })} />
                    <HelpModal isOpen={showHelpModal} onClose={() => setShowHelpModal(false)} />
                    
                    <div className="bg-white p-6 rounded-2xl shadow-xl">
                        {/* Cabecera */}
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4">
                            <div className="flex items-center space-x-4">
                                <h1 className="text-3xl font-extrabold text-gray-800">Histórico de Lotes</h1>
                                <button onClick={() => setShowHelpModal(true)} title="Ayuda" className="text-gray-400 hover:text-indigo-600"><i className="fas fa-question-circle text-2xl"></i></button>
                            </div>
                            <div className="flex items-center space-x-3 mt-4 sm:mt-0">
                                <a href="generarqr.html" className="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 shadow-sm"><i className="fas fa-plus mr-2"></i>Generar Nuevo</a>
                                <a href="index.html" className="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Volver al Menú</a>
                            </div>
                        </div>
                        
                        {/* Filtros de Fecha */}
                        <div className="mb-6 p-4 border rounded-lg bg-gray-50">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">Fecha Desde</label><input type="date" value={fechaDesde} onChange={e => handleDateChange(setFechaDesde, e.target.value)} className="w-full rounded-md border-gray-300 shadow-sm p-2 border"/></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">Fecha Hasta</label><input type="date" value={fechaHasta} onChange={e => handleDateChange(setFechaHasta, e.target.value)} className="w-full rounded-md border-gray-300 shadow-sm p-2 border"/></div>
                                <div className="flex items-end"><button onClick={clearFilters} className="w-full bg-white text-gray-700 border font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-50"><i className="fas fa-times-circle mr-2"></i>Limpiar Filtros</button></div>
                            </div>
                        </div>

                        {/* Botones de Acción Principal */}
                        <div className="flex flex-col sm:flex-row justify-between items-center mb-4">
                            <div className="flex space-x-2">
                                <button onClick={handlePendientesClick} disabled={isTransferMode} className="bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-orange-600 disabled:opacity-50 flex items-center"><i className="fas fa-box-open mr-2"></i>Pendientes por Almacenar</button>
                                {isTransferMode && <button onClick={handleConfirmarAlmacenamiento} className="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-teal-600 flex items-center animate-pulse"><i className="fas fa-check-double mr-2"></i>Confirmar Almacenamiento</button>}
                            </div>
                            <div className="flex space-x-2 mt-4 sm:mt-0">
                                <button onClick={() => loadData()} disabled={isLoading || isSaving} className="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 disabled:opacity-50"><i className={`fas fa-sync-alt ${isLoading ? 'animate-spin' : ''} mr-2`}></i>Refrescar</button>
                                {/* ... (Menú de exportar) ... */}
                            </div>
                        </div>
                        <p className="text-gray-600 font-semibold mb-4">{isTransferMode ? `${selectedForTransfer.size} de ${filteredData.length} pendiente(s) seleccionado(s)` : `${filteredData.length} registro(s) encontrado(s)`}</p>

                        {/* Tabla de Datos */}
                        <div className="overflow-x-auto rounded-lg shadow-md border" style={{ maxHeight: '60vh' }}>
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-800 text-white sticky top-0 z-10">
                                    <tr>
                                        <th style={{width: '1%'}} className="px-2 py-3 text-left text-xs font-medium uppercase tracking-wider">TRANSFERIDO</th>
                                        {["SKU", "Descripción", "Nº Pallet", "Lotes Prod.", "Acciones"].map(header => ( <th key={header} className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">{header}</th> ))}
                                    </tr>
                                    <tr className="bg-gray-200">
                                        <th className="p-1"></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.sku} onChange={e => handleColumnFilterChange('sku', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.descripcion} onChange={e => handleColumnFilterChange('descripcion', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.numeroDePallet} onChange={e => handleColumnFilterChange('numeroDePallet', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.lotesProduccion} onChange={e => handleColumnFilterChange('lotesProduccion', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"></th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {isLoading ? ( <tr><td colSpan="6" className="p-8 text-center text-gray-500">Cargando datos...</td></tr> ) : (
                                        filteredData.length > 0 ? filteredData.map((item) => {
                                            const rowClassName = item.hasNote ? 'bg-yellow-50 hover:bg-yellow-100' : 'hover:bg-gray-50';
                                            return (
                                            <tr key={item.id} className={rowClassName} onDoubleClick={() => item.hasNote && !isTransferMode && alert(item.noteText)}>
                                                <td className="px-2 py-2 text-center align-middle">
                                                    <input type="checkbox"
                                                        className="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 disabled:opacity-50"
                                                        checked={item.isTransferred || selectedForTransfer.has(item.id)}
                                                        disabled={!isTransferMode || item.isTransferred}
                                                        onChange={() => handleTransferSelection(item.id)}
                                                    />
                                                </td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">{item.sku}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.descripcion}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm font-semibold">{item.numeroDePallet}{item.hasNote && <span className="text-red-500 ml-1">(*)</span>}</td>
                                                <td className="px-4 py-2 text-sm text-gray-600">{item.lotesProduccion.replace(/#/g, ', ')}</td>
                                                <td className="px-4 py-2 text-center">
                                                    <div className="relative" ref={activeActionMenu === item.id ? actionMenuRef : null}>
                                                        <button disabled={isTransferMode} onClick={() => setActiveActionMenu(activeActionMenu === item.id ? null : item.id)} className="text-gray-500 hover:text-blue-600 p-2 rounded-full disabled:opacity-50 disabled:cursor-not-allowed"><i className="fas fa-ellipsis-v"></i></button>
                                                        {activeActionMenu === item.id && (
                                                            <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border z-30">
                                                                <ul className="text-gray-700 text-left">
                                                                    <li><button onClick={() => { handleReprint(item); setActiveActionMenu(null); }} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-print w-6 mr-2 text-blue-500"></i>Reimprimir Etiqueta</button></li>
                                                                    {/* Otros botones de acción se pueden añadir aquí */}
                                                                </ul>
                                                            </div>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                            )
                                        }) : ( <tr><td colSpan="6" className="px-4 py-8 text-center text-sm text-gray-500">No se encontraron registros.</td></tr> )
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
