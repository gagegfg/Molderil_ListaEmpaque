<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLDERIL - Histórico de Lotes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans">

    <div id="static-loader" class="fixed inset-0 bg-gray-100 flex items-center justify-center p-4 font-sans z-50 transition-opacity duration-500">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-wide mb-6" style="font-family: 'Arial', sans-serif;">MOLDERIL S.A.</h1>
            <p id="loader-status" class="text-xl text-gray-600 mb-4">Cargando aplicación...</p>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="loader-progress" class="bg-indigo-600 h-4 rounded-full transition-all duration-500" style="width: 10%"></div>
            </div>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;
        const { jsPDF } = window.jspdf;

        // --- CONFIGURACIÓN DE GITHUB ---
        const GITHUB_USER = 'gagegfg';
        const GITHUB_REPO = 'Molderil_ListaEmpaque';
        const CSV_PATH = 'detallelotes.csv';

        // Hook personalizado para manejar el estado con localStorage
        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.log(error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {
                    console.log(error);
                }
            };
            return [storedValue, setValue];
        };
        
        const App = () => {
            const [allData, setAllData] = useState([]);
            const [filteredData, setFilteredData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [apiToken, setApiToken] = useState(null);
            const [clientList, setClientList] = useState([]);

            // Estado para modales y menús
            const [modalState, setModalState] = useState({ isOpen: false, type: null, title: '', message: '', onConfirm: null });
            const [showHelpModal, setShowHelpModal] = useState(false);
            const [activeActionMenu, setActiveActionMenu] = useState(null);
            const actionMenuRef = useRef(null);
            
            const getInitialDate = (daysOffset = 0) => {
                const date = new Date();
                date.setDate(date.getDate() + daysOffset);
                return date.toISOString().split('T')[0];
            };

            const [columnFilters, setColumnFilters] = useLocalStorage('grillaqr_columnFilters_v3', {
                sku: '',
                descripcion: '',
                numeroDePallet: '',
                lotesProduccion: '',
                despachado: '',
                cliente: ''
            });
            const [fechaDesde, setFechaDesde] = useLocalStorage('grillaqr_fechaDesde', getInitialDate(-365));
            const [fechaHasta, setFechaHasta] = useLocalStorage('grillaqr_fechaHasta', getInitialDate());
            
            const [isExportOpen, setIsExportOpen] = useState(false);
            const exportMenuRef = useRef(null);
            
            // --- FUNCIONES DE API Y DATOS ---

            const getApiToken = async (file) => {
                try {
                    const response = await fetch(file + '?t=' + new Date().getTime()); // Evitar cache
                    if (!response.ok) throw new Error(`No se pudo cargar ${file}.`);
                    let rawText = await response.text();
                    return rawText.replace(/aaaa/g, '').replace(/bbbb/g, '').replace(/cccc/g, '').trim();
                } catch (error) {
                    console.error(`Error al obtener ${file}:`, error);
                    return null;
                }
            };

            const fetchData = async () => {
                setIsLoading(true);
                try {
                    const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/${CSV_PATH}?timestamp=` + new Date().getTime());
                    if (!response.ok) throw new Error('No se pudo cargar el histórico.');
                    const text = await response.text();
                    const rows = text.split('\n').filter(Boolean);
                    const parsedData = rows.map((row, index) => {
                        const [sku, descripcion, numeroDePallet, lotesProduccion, fechaProduccion, cantidad, unidadMedida, despachado, cliente] = row.split(';');
                        return { id: index, sku, descripcion, numeroDePallet, lotesProduccion, fechaProduccion, cantidad, unidadMedida, despachado, cliente };
                    });
                    setAllData(parsedData);
                } catch (error) {
                    console.error("Error cargando detallelotes.csv:", error);
                    alert("Error al cargar el histórico de lotes.");
                } finally {
                    setIsLoading(false);
                }
            };

            const saveToGitHub = async (dataToSave) => {
                if (!apiToken) {
                    alert("Error: El token de API no está disponible.");
                    return false;
                }
                setIsSaving(true);
                const csvContent = dataToSave.map(item => [item.sku, item.descripcion, item.numeroDePallet, item.lotesProduccion, item.fechaProduccion, item.cantidad, item.unidadMedida, item.despachado || 'FALSE', item.cliente || ''].join(';')).join('\n');
                const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${CSV_PATH}`;

                try {
                    const fileResponse = await fetch(url, { headers: { 'Authorization': `token ${apiToken}` } });
                    if (!fileResponse.ok) throw new Error(`Error ${fileResponse.status}: No se pudo obtener info del archivo.`);
                    const fileData = await fileResponse.json();

                    const updateResponse = await fetch(url, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${apiToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: 'Actualización de histórico desde grilla web',
                            content: btoa(unescape(encodeURIComponent(csvContent))),
                            sha: fileData.sha,
                        }),
                    });

                    if (!updateResponse.ok) throw new Error(`Error ${updateResponse.status}: Falló la actualización.`);
                    alert("¡Histórico guardado correctamente en GitHub!");
                    setAllData(dataToSave);
                    return true;
                } catch (e) {
                    alert(`ERROR al guardar en GitHub: ${e.message}`);
                    return false;
                } finally {
                    setIsSaving(false);
                }
            };
            
            const verifyPasswordAndExecute = async (actionCallback, password) => {
                if (!password) {
                    alert("Por favor, ingrese la contraseña.");
                    return;
                }
                const correctPassword = await getApiToken('pswsku.txt');
                if (password.trim() === correctPassword) {
                    setModalState({ isOpen: false }); // Cerrar modal antes de ejecutar
                    actionCallback();
                } else {
                    alert("Contraseña incorrecta.");
                }
            };
            
            // --- EFECTOS ---

            useEffect(() => {
                const staticLoader = document.getElementById('static-loader');
                const loaderStatus = document.getElementById('loader-status');
                const loaderProgress = document.getElementById('loader-progress');

                const initializeApp = async () => {
                    loaderStatus.textContent = "Verificando acceso...";
                    loaderProgress.style.width = '25%';
                    const token = await getApiToken('cls.txt');
                    setApiToken(token);

                    loaderStatus.textContent = "Cargando lista de clientes...";
                    loaderProgress.style.width = '50%';
                    try {
                        const clientResponse = await fetch('clientes.txt?t=' + new Date().getTime());
                        const clientText = await clientResponse.text();
                        const clients = clientText.split('\n').map(c => c.trim().toUpperCase()).filter(Boolean);
                        setClientList(clients);
                    } catch (e) {
                        console.error("No se pudo cargar la lista de clientes.");
                    }

                    loaderStatus.textContent = "Cargando histórico...";
                    loaderProgress.style.width = '75%';
                    await fetchData();
                    
                    loaderStatus.textContent = "¡Listo!";
                    loaderProgress.style.width = '100%';
                    
                    setTimeout(() => {
                         if (staticLoader) {
                            staticLoader.classList.add('opacity-0');
                            setTimeout(() => staticLoader.remove(), 500);
                        }
                    }, 500);
                };
                
                initializeApp();
            }, []);

            useEffect(() => {
                let data = [...allData];
                Object.keys(columnFilters).forEach(key => {
                    const filterValue = columnFilters[key].toLowerCase();
                    if (filterValue) {
                        data = data.filter(item => {
                            if (key === 'despachado') {
                                const despachadoText = (item.despachado && item.despachado.toUpperCase() === 'TRUE') ? 'sí' : 'no';
                                return despachadoText.includes(filterValue);
                            }
                            return item[key] && item[key].toString().toLowerCase().includes(filterValue)
                        });
                    }
                });
                const desde = fechaDesde ? new Date(fechaDesde + 'T00:00:00') : null;
                const hasta = fechaHasta ? new Date(fechaHasta + 'T23:59:59') : null;
                if (desde || hasta) {
                    data = data.filter(item => {
                        if (!item.fechaProduccion) return false;
                        const fechaItemParts = item.fechaProduccion.split('/');
                        if (fechaItemParts.length !== 3) return false;
                        const fechaItem = new Date(`${fechaItemParts[2]}-${fechaItemParts[1]}-${fechaItemParts[0]}`);
                        if (desde && hasta) return fechaItem >= desde && fechaItem <= hasta;
                        if (desde) return fechaItem >= desde;
                        if (hasta) return fechaItem <= hasta;
                        return true;
                    });
                }
                setFilteredData(data);
            }, [columnFilters, fechaDesde, fechaHasta, allData]);
            
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (exportMenuRef.current && !exportMenuRef.current.contains(event.target)) setIsExportOpen(false);
                    if (actionMenuRef.current && !actionMenuRef.current.contains(event.target)) setActiveActionMenu(null);
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            // --- MANEJADORES DE ACCIONES ---

            const handleColumnFilterChange = (columnId, value) => setColumnFilters(prev => ({ ...prev, [columnId]: value }));
            const clearFilters = () => {
                setColumnFilters({ sku: '', descripcion: '', numeroDePallet: '', lotesProduccion: '', despachado: '', cliente: '' });
                setFechaDesde('');
                setFechaHasta('');
            };

            const handleDeleteRow = (rowId) => {
                setModalState({ 
                    isOpen: true, 
                    type: 'confirm', 
                    title: `Confirmar Eliminación`,
                    message: `¿Seguro que quieres eliminar la fila? Esta acción es irreversible.`,
                    onConfirm: () => {
                        setModalState({
                            isOpen: true,
                            type: 'password',
                            title: 'Ingrese Contraseña',
                            message: 'Para confirmar la eliminación, ingrese la contraseña de administrador.',
                            onConfirm: (password) => {
                                verifyPasswordAndExecute(() => {
                                    const newData = allData.filter(item => item.id !== rowId);
                                    saveToGitHub(newData);
                                }, password);
                            }
                        });
                    }
                });
            };

            const handleRevertDispatch = (rowId) => {
                const itemToRevert = allData.find(item => item.id === rowId);
                if (!itemToRevert || itemToRevert.despachado?.toUpperCase() !== 'TRUE') {
                    alert("Esta acción solo se puede realizar en un lote que ya ha sido despachado (estado 'Sí').");
                    return;
                }

                setModalState({
                    isOpen: true,
                    type: 'confirm',
                    title: 'Confirmar Reversión',
                    message: 'Esta acción marcará el lote como NO despachado y limpiará el cliente.',
                    onConfirm: () => {
                        setModalState({
                            isOpen: true,
                            type: 'password',
                            title: 'Ingrese Contraseña',
                            message: 'Para confirmar la reversión, ingrese la contraseña de administrador.',
                            onConfirm: (password) => {
                                verifyPasswordAndExecute(() => {
                                    const newData = allData.map(item => {
                                        if (item.id === rowId) {
                                            return { ...item, despachado: 'FALSE', cliente: '' };
                                        }
                                        return item;
                                    });
                                    saveToGitHub(newData);
                                }, password);
                            }
                        });
                    }
                });
            };
            
            const handleChangeClient = (rowId) => {
                setModalState({
                    isOpen: true,
                    type: 'textInputWithSuggestions',
                    title: 'Cambiar Cliente',
                    message: 'Ingrese el nuevo nombre del cliente:',
                    onConfirm: (newClient) => {
                         if (!newClient) {
                            alert("El nombre del cliente no puede estar vacío.");
                            return;
                         }
                         setModalState({
                            isOpen: true,
                            type: 'password',
                            title: 'Confirmar Cambio de Cliente',
                            message: `Se asignará el cliente "${newClient}" y el lote se marcará como despachado. Ingrese la contraseña para confirmar.`,
                            onConfirm: (password) => {
                                verifyPasswordAndExecute(() => {
                                    const newData = allData.map(item => {
                                        if (item.id === rowId) {
                                            return { ...item, cliente: newClient.toUpperCase(), despachado: 'TRUE' };
                                        }
                                        return item;
                                    });
                                    saveToGitHub(newData);
                                }, password);
                            }
                        });
                    }
                });
            };

            // --- FUNCIONES DE EXPORTACIÓN ---
            const exportToPDF = () => {
                const doc = new jsPDF({ orientation: 'landscape' });
                doc.setFontSize(18);
                doc.text("Histórico de Lotes Generados", 14, 16);
                
                const tableColumn = ["SKU", "Descripción", "Nº Pallet", "Lotes Prod.", "Despachado", "Cliente", "F. Prod.", "Cantidad", "U.M."];
                const tableRows = [];

                filteredData.forEach(item => {
                    const despachadoText = (item.despachado && item.despachado.toUpperCase() === 'TRUE') ? 'Sí' : 'No';
                    const rowData = [
                        item.sku, item.descripcion, item.numeroDePallet, item.lotesProduccion,
                        despachadoText, item.cliente || '', item.fechaProduccion, item.cantidad, item.unidadMedida
                    ];
                    tableRows.push(rowData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 22,
                    theme: 'grid',
                    headStyles: { fillColor: [22, 160, 133] }
                });
                
                doc.save("historico_lotes.pdf");
                setIsExportOpen(false);
            };

            const exportToExcel = () => {
                const excelData = filteredData.map(item => ({
                    'SKU': item.sku, 
                    'Descripción': item.descripcion, 
                    'Nº Pallet': item.numeroDePallet,
                    'Lotes Producción': item.lotesProduccion, 
                    'Despachado': (item.despachado && item.despachado.toUpperCase() === 'TRUE') ? 'Sí' : 'No',
                    'Cliente': item.cliente || '',
                    'Fecha Producción': item.fechaProduccion,
                    'Cantidad': item.cantidad, 
                    'Unidad Medida': item.unidadMedida
                }));
                const worksheet = XLSX.utils.json_to_sheet(excelData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Histórico");
                XLSX.writeFile(workbook, "historico_lotes.xlsx");
                setIsExportOpen(false);
            };
            
            // --- COMPONENTES DE UI ---

            const ActionModal = ({ isOpen, type, title, message, onConfirm, onClose, suggestions }) => {
                if (!isOpen) return null;
                const [inputValue, setInputValue] = useState('');
                const [showSuggestions, setShowSuggestions] = useState(false);
                const inputRef = useRef(null);
                const modalContentRef = useRef(null);

                useEffect(() => {
                    if (isOpen) setTimeout(() => inputRef.current?.focus(), 100);
                }, [isOpen]);

                useEffect(() => {
                    const handleClickOutside = (e) => {
                        if (modalContentRef.current && !modalContentRef.current.contains(e.target)) {
                           setShowSuggestions(false);
                        }
                    };
                    document.addEventListener('mousedown', handleClickOutside);
                    return () => document.removeEventListener('mousedown', handleClickOutside);
                }, []);

                const handleConfirm = () => onConfirm(inputValue);
                
                const filteredSuggestions = suggestions ? suggestions.filter(s => s.toLowerCase().includes(inputValue.toLowerCase())) : [];

                return (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                        <div ref={modalContentRef} className="bg-white p-6 rounded-xl shadow-lg w-full max-w-sm">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">{title}</h3>
                            <p className="text-sm text-gray-600 mb-4">{message}</p>
                            {type !== 'confirm' && (
                                <div className="relative">
                                    <input
                                        ref={inputRef}
                                        type={type === 'password' ? 'password' : 'text'}
                                        value={inputValue}
                                        onChange={e => {
                                            setInputValue(e.target.value);
                                            if (type === 'textInputWithSuggestions') setShowSuggestions(true);
                                        }}
                                        onKeyDown={e => e.key === 'Enter' && handleConfirm()}
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"
                                        autoComplete="off"
                                    />
                                    {type === 'textInputWithSuggestions' && showSuggestions && filteredSuggestions.length > 0 && (
                                        <ul className="absolute z-10 w-full bg-white border rounded-md mt-1 max-h-40 overflow-y-auto shadow-lg">
                                            {filteredSuggestions.map(client => (
                                                <li key={client} className="p-2 hover:bg-indigo-100 cursor-pointer" onClick={() => { setInputValue(client); setShowSuggestions(false); }}>
                                                    {client}
                                                </li>
                                            ))}
                                        </ul>
                                    )}
                                </div>
                            )}
                            <div className="flex justify-end space-x-3 mt-6">
                                <button onClick={onClose} className="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                                <button onClick={handleConfirm} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Aceptar</button>
                            </div>
                        </div>
                    </div>
                );
            };
            
            const HelpModal = ({ onClose }) => (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="relative p-6 bg-white w-full max-w-2xl rounded-xl shadow-lg m-4 max-h-[90vh] overflow-y-auto">
                        <h3 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Guía de Uso del Histórico</h3>
                        <div className="space-y-4 text-gray-700">
                            <div>
                                <h4 className="font-semibold text-lg text-indigo-600">1. Filtrado de Datos</h4>
                                <p>Puedes acotar tu búsqueda de varias formas:</p>
                                <ul className="list-disc list-inside ml-4 mt-1">
                                    <li><strong>Filtros de Columna:</strong> Escribe en los campos debajo de los títulos de la tabla para filtrar por cualquier columna. Por ejemplo, escribe "Sí" o "No" en el filtro de "Despachado".</li>
                                    <li><strong>Filtro por Fechas:</strong> Utiliza los calendarios "Fecha Desde" y "Fecha Hasta" para ver los registros de un período específico.</li>
                                    <li><strong>Limpiar Filtros:</strong> Usa el botón para borrar todos los filtros aplicados y ver todos los registros.</li>
                                </ul>
                            </div>
                             <div>
                                <h4 className="font-semibold text-lg text-indigo-600">2. Acciones Principales</h4>
                                <ul className="list-disc list-inside ml-4 mt-1">
                                    <li><strong>Refrescar:</strong> Vuelve a cargar los datos directamente desde el archivo en GitHub.</li>
                                    <li><strong>Exportar:</strong> Despliega un menú para descargar la vista actual de la tabla en formato PDF o Excel.</li>
                                </ul>
                            </div>
                            <div>
                                <h4 className="font-semibold text-lg text-indigo-600">3. Acciones por Fila</h4>
                                <p>En la última columna ("Acciones"), haz clic en el ícono de tres puntos (⋮) para desplegar un menú con las siguientes opciones:</p>
                                <ul className="list-disc list-inside ml-4 mt-1">
                                    <li><strong>Cambiar Cliente:</strong> Permite asignar o cambiar el cliente de un lote. Al hacerlo, el estado del lote pasará automáticamente a "Despachado: Sí".</li>
                                    <li><strong>Revertir Despacho:</strong> Cambia el estado de un lote de "Sí" a "No" y elimina el nombre del cliente. Esta opción solo está disponible si el lote ya fue despachado.</li>
                                    <li><strong>Eliminar Fila:</strong> Borra permanentemente el registro del lote del archivo.</li>
                                </ul>
                                <p className="mt-2 text-sm font-bold text-red-600">Importante: Todas las acciones por fila (cambiar cliente, revertir y eliminar) requieren una contraseña de administrador para confirmar y guardar los cambios.</p>
                            </div>
                        </div>
                        <div className="text-center mt-6">
                            <button onClick={onClose} className="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md shadow-md hover:bg-indigo-700">
                                Entendido
                            </button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-100 p-4 sm:p-6">
                    {isSaving && (
                        <div className="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
                            <div className="flex items-center space-x-3 text-xl font-semibold text-gray-700">
                                <i className="fas fa-sync-alt animate-spin"></i>
                                <span>Guardando en GitHub...</span>
                            </div>
                        </div>
                    )}
                    <ActionModal 
                        isOpen={modalState.isOpen}
                        type={modalState.type}
                        title={modalState.title}
                        message={modalState.message}
                        onClose={() => setModalState({ isOpen: false })}
                        onConfirm={modalState.onConfirm}
                        suggestions={clientList}
                    />
                    {showHelpModal && <HelpModal onClose={() => setShowHelpModal(false)} />}
                    <div className="bg-white p-6 rounded-2xl shadow-xl">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4 border-gray-200">
                            <div className="flex items-center space-x-4">
                                <h1 className="text-3xl font-extrabold text-gray-800">Histórico de Lotes</h1>
                                <button onClick={() => setShowHelpModal(true)} title="Ayuda" className="text-gray-400 hover:text-indigo-600 transition-colors">
                                    <i className="fas fa-question-circle text-2xl"></i>
                                </button>
                            </div>
                            <a href="index.html" className="mt-4 sm:mt-0 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Volver al Menú</a>
                        </div>
                        
                        <div className="mb-6 p-4 border rounded-lg bg-gray-50 space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Fecha Desde</label>
                                    <input type="date" value={fechaDesde} onChange={e => setFechaDesde(e.target.value)} className="w-full rounded-md border-gray-300 shadow-sm p-2 border"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Fecha Hasta</label>
                                    <input type="date" value={fechaHasta} onChange={e => setFechaHasta(e.target.value)} className="w-full rounded-md border-gray-300 shadow-sm p-2 border"/>
                                </div>
                                <div className="flex items-end">
                                    <button onClick={clearFilters} className="w-full bg-white text-gray-700 border border-gray-300 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-50 flex items-center justify-center">
                                        <i className="fas fa-times-circle mr-2"></i>Limpiar Filtros
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="flex flex-col sm:flex-row justify-between items-center mb-4">
                            <p className="text-gray-600 font-semibold">{filteredData.length} registro(s) encontrado(s)</p>
                            <div className="flex space-x-2 mt-4 sm:mt-0">
                                <button onClick={fetchData} disabled={isLoading || isSaving} className="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 disabled:opacity-50 flex items-center">
                                    <i className={`fas fa-sync-alt ${isLoading ? 'animate-spin' : ''} mr-2`}></i>Refrescar
                                </button>
                                <div className="relative" ref={exportMenuRef}>
                                    <button onClick={() => setIsExportOpen(prev => !prev)} disabled={filteredData.length === 0} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 disabled:opacity-50 flex items-center">
                                        <i className="fas fa-download mr-2"></i>Exportar<i className={`fas fa-chevron-down ml-2 transition-transform ${isExportOpen ? 'rotate-180' : ''}`}></i>
                                    </button>
                                    {isExportOpen && (
                                        <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border z-20">
                                            <ul className="text-gray-700">
                                                <li><button onClick={exportToPDF} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-file-pdf w-6 mr-2 text-red-500"></i>Exportar a PDF</button></li>
                                                <li><button onClick={exportToExcel} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-file-excel w-6 mr-2 text-green-500"></i>Exportar a Excel</button></li>
                                            </ul>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="overflow-x-auto rounded-lg shadow-md border">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-800 text-white sticky top-0 z-10">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">SKU</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Descripción</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Nº Pallet</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Lotes Prod.</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Despachado</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Cliente</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">F. Prod.</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Cantidad</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">U.M.</th>
                                        <th className="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider">Acciones</th>
                                    </tr>
                                    <tr className="bg-gray-200">
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.sku} onChange={e => handleColumnFilterChange('sku', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.descripcion} onChange={e => handleColumnFilterChange('descripcion', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.numeroDePallet} onChange={e => handleColumnFilterChange('numeroDePallet', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.lotesProduccion} onChange={e => handleColumnFilterChange('lotesProduccion', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Sí / No" value={columnFilters.despachado} onChange={e => handleColumnFilterChange('despachado', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"><input type="text" placeholder="Filtrar..." value={columnFilters.cliente} onChange={e => handleColumnFilterChange('cliente', e.target.value)} className="w-full p-1 text-sm text-gray-700 border rounded"/></th>
                                        <th className="p-1"></th>
                                        <th className="p-1"></th>
                                        <th className="p-1"></th>
                                        <th className="p-1"></th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {isLoading ? (
                                        <tr><td colSpan="10" className="p-8 text-center text-gray-500">Cargando datos...</td></tr>
                                    ) : (
                                        filteredData.length > 0 ? filteredData.map((item, index) => {
                                            const isDespachado = item.despachado && item.despachado.toUpperCase() === 'TRUE';
                                            return (
                                            <tr key={item.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">{item.sku}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.descripcion}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.numeroDePallet}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.lotesProduccion}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm font-semibold">
                                                    <span className={isDespachado ? 'text-green-600' : 'text-red-600'}>
                                                        {isDespachado ? 'Sí' : 'No'}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.cliente || ''}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.fechaProduccion}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.cantidad}</td>
                                                <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-600">{item.unidadMedida}</td>
                                                <td className="px-4 py-2 text-center">
                                                    <div className="relative" ref={activeActionMenu === item.id ? actionMenuRef : null}>
                                                        <button onClick={() => setActiveActionMenu(activeActionMenu === item.id ? null : item.id)} className="text-gray-500 hover:text-blue-600 p-2 rounded-full">
                                                            <i className="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        {activeActionMenu === item.id && (
                                                            <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border z-30">
                                                                <ul className="text-gray-700 text-left">
                                                                    <li><button onClick={() => { handleChangeClient(item.id); setActiveActionMenu(null); }} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-user-edit w-6 mr-2 text-blue-500"></i>Cambiar Cliente</button></li>
                                                                    <li><button onClick={() => { handleRevertDispatch(item.id); setActiveActionMenu(null); }} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-undo w-6 mr-2 text-orange-500"></i>Revertir Despacho</button></li>
                                                                    <li><hr className="my-1"/></li>
                                                                    <li><button onClick={() => { handleDeleteRow(item.id); setActiveActionMenu(null); }} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-trash-alt w-6 mr-2 text-red-500"></i>Eliminar Fila</button></li>
                                                                </ul>
                                                            </div>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                            )
                                        }) : (
                                            <tr>
                                                <td colSpan="10" className="px-4 py-8 text-center text-sm text-gray-500">No se encontraron registros con los filtros aplicados.</td>
                                            </tr>
                                        )
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
