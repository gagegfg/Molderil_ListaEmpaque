<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLDERIL - Histórico de Lotes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans">

    <div id="static-loader" class="fixed inset-0 bg-gray-100 flex items-center justify-center p-4 font-sans z-50 transition-opacity duration-500">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-wide mb-6" style="font-family: 'Arial', sans-serif;">MOLDERIL S.A.</h1>
            <p id="loader-status" class="text-xl text-gray-600 mb-4">Cargando aplicación...</p>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="loader-progress" class="bg-indigo-600 h-4 rounded-full transition-all duration-500" style="width: 10%"></div>
            </div>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;
        const { jsPDF } = window.jspdf;

        // Hook personalizado para manejar el estado con localStorage
        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.log(error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {
                    console.log(error);
                }
            };
            return [storedValue, setValue];
        };
        
        const App = () => {
            const [allData, setAllData] = useState([]);
            const [filteredData, setFilteredData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            
            // Lógica para fechas por defecto
            const getInitialDate = (daysOffset = 0) => {
                const date = new Date();
                date.setDate(date.getDate() + daysOffset);
                return date.toISOString().split('T')[0];
            };

            // Estados de los filtros usando el hook de localStorage
            const [searchTerm, setSearchTerm] = useLocalStorage('grillaqr_searchTerm', '');
            const [loteTerm, setLoteTerm] = useLocalStorage('grillaqr_loteTerm', '');
            const [fechaDesde, setFechaDesde] = useLocalStorage('grillaqr_fechaDesde', getInitialDate(-365));
            const [fechaHasta, setFechaHasta] = useLocalStorage('grillaqr_fechaHasta', getInitialDate());
            
            const [isExportOpen, setIsExportOpen] = useState(false);
            const exportMenuRef = useRef(null);

            const fetchData = async () => {
                setIsLoading(true);
                try {
                    const response = await fetch('https://raw.githubusercontent.com/gagegfg/Molderil_ListaEmpaque/main/detallelotes.csv?timestamp=' + new Date().getTime());
                    if (!response.ok) throw new Error('No se pudo cargar el histórico.');
                    const text = await response.text();
                    const rows = text.split('\n').filter(Boolean);
                    const parsedData = rows.map((row, index) => {
                        const [sku, descripcion, numeroDePallet, lotesProduccion, fechaProduccion, cantidad, unidadMedida] = row.split(';');
                        return { id: index, sku, descripcion, numeroDePallet, lotesProduccion, fechaProduccion, cantidad, unidadMedida };
                    });
                    setAllData(parsedData);
                } catch (error) {
                    console.error("Error cargando detallelotes.csv:", error);
                    alert("Error al cargar el histórico de lotes.");
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => {
                const staticLoader = document.getElementById('static-loader');
                const loaderStatus = document.getElementById('loader-status');
                const loaderProgress = document.getElementById('loader-progress');

                const loadingTasks = [
                    { status: "Inicializando...", duration: 300, progress: 20 },
                    { status: "Cargando histórico...", duration: 1200, progress: 85, action: fetchData },
                    { status: "¡Listo!", duration: 500, progress: 100 }
                ];

                let currentTask = 0;
                const runLoadingTask = () => {
                    if (currentTask < loadingTasks.length) {
                        const task = loadingTasks[currentTask];
                        if (loaderStatus) loaderStatus.textContent = task.status;
                        if (loaderProgress) loaderProgress.style.width = `${task.progress}%`;
                        if (task.action) task.action();
                        setTimeout(() => {
                            currentTask++;
                            runLoadingTask();
                        }, task.duration);
                    } else {
                        if (staticLoader) {
                            staticLoader.classList.add('opacity-0');
                            setTimeout(() => staticLoader.remove(), 500);
                        }
                    }
                };
                runLoadingTask();
            }, []);

            useEffect(() => {
                let data = [...allData];

                if (searchTerm) {
                    const lowercasedTerm = searchTerm.toLowerCase();
                    data = data.filter(item =>
                        (item.sku && item.sku.toLowerCase().includes(lowercasedTerm)) ||
                        (item.descripcion && item.descripcion.toLowerCase().includes(lowercasedTerm))
                    );
                }

                if (loteTerm) {
                    const lowercasedLote = loteTerm.toLowerCase();
                    data = data.filter(item => 
                        item.lotesProduccion && item.lotesProduccion.toLowerCase().includes(lowercasedLote)
                    );
                }

                const desde = fechaDesde ? new Date(fechaDesde + 'T00:00:00') : null;
                const hasta = fechaHasta ? new Date(fechaHasta + 'T23:59:59') : null;

                if (desde || hasta) {
                    data = data.filter(item => {
                        if (!item.fechaProduccion) return false;
                        const fechaItemParts = item.fechaProduccion.split('/');
                        if (fechaItemParts.length !== 3) return false;
                        const fechaItem = new Date(`${fechaItemParts[2]}-${fechaItemParts[1]}-${fechaItemParts[0]}`);
                        
                        if (desde && hasta) return fechaItem >= desde && fechaItem <= hasta;
                        if (desde) return fechaItem >= desde;
                        if (hasta) return fechaItem <= hasta;
                        return true;
                    });
                }

                setFilteredData(data);
            }, [searchTerm, loteTerm, fechaDesde, fechaHasta, allData]);
            
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (exportMenuRef.current && !exportMenuRef.current.contains(event.target)) {
                        setIsExportOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const clearFilters = () => {
                setSearchTerm('');
                setLoteTerm('');
                setFechaDesde('');
                setFechaHasta('');
            };

            const exportToPDF = () => {
                const doc = new jsPDF({ orientation: 'landscape' });
                const pageTitle = "Histórico de Lotes Generados";
                const filtersApplied = `Filtros: Artículo: "${searchTerm || 'Todos'}" | Lote: "${loteTerm || 'Todos'}" | Desde: ${fechaDesde || 'N/A'} | Hasta: ${fechaHasta || 'N/A'}`;
                const generationDate = `Generado el: ${new Date().toLocaleDateString('es-ES')} ${new Date().toLocaleTimeString('es-ES')}`;

                doc.setFontSize(18);
                doc.text(pageTitle, 14, 16);
                doc.setFontSize(8);
                doc.text(filtersApplied, 14, 22);
                doc.text(generationDate, 14, 26);
                
                const tableColumn = ["SKU", "Descripción", "Nº Pallet", "Lotes Prod.", "F. Prod.", "Cantidad", "U.M."];
                const tableRows = [];

                filteredData.forEach(item => {
                    const rowData = [
                        item.sku,
                        item.descripcion,
                        item.numeroDePallet,
                        item.lotesProduccion,
                        item.fechaProduccion,
                        item.cantidad,
                        item.unidadMedida
                    ];
                    tableRows.push(rowData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 30,
                    theme: 'grid',
                    headStyles: { fillColor: [22, 160, 133] }
                });
                
                doc.save("historico_lotes.pdf");
                setIsExportOpen(false);
            };

            const exportToExcel = () => {
                const worksheet = XLSX.utils.json_to_sheet(filteredData.map(item => ({
                    'SKU': item.sku,
                    'Descripción': item.descripcion,
                    'Nº Pallet': item.numeroDePallet,
                    'Lotes Producción': item.lotesProduccion,
                    'Fecha Producción': item.fechaProduccion,
                    'Cantidad': item.cantidad,
                    'Unidad Medida': item.unidadMedida
                })));
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Histórico");
                XLSX.writeFile(workbook, "historico_lotes.xlsx");
                setIsExportOpen(false);
            };

            return (
                <div className="min-h-screen bg-gray-100 p-4 sm:p-6">
                    <div className="bg-white p-6 rounded-2xl shadow-xl">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4 border-gray-200">
                            <div>
                                <h1 className="text-3xl font-extrabold text-gray-800">Histórico de Lotes</h1>
                                <p className="text-gray-500 mt-1">Consulta y exporta los registros de pallets generados.</p>
                            </div>
                            <a href="index.html" className="mt-4 sm:mt-0 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Volver al Menú</a>
                        </div>
                        
                        <div className="mb-6 p-4 border rounded-lg bg-gray-50 space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div className="relative">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Buscar por Artículo</label>
                                    <i className="fa fa-search absolute left-3 top-9 text-gray-400"></i>
                                    <input 
                                        type="text"
                                        placeholder="SKU o descripción..."
                                        value={searchTerm}
                                        onChange={e => setSearchTerm(e.target.value)}
                                        className="w-full rounded-md border-gray-300 shadow-sm p-2 pl-10 border"
                                    />
                                </div>
                                <div className="relative">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Buscar por Lote</label>
                                    <i className="fa fa-tag absolute left-3 top-9 text-gray-400"></i>
                                    <input 
                                        type="text"
                                        placeholder="Lote de producción..."
                                        value={loteTerm}
                                        onChange={e => setLoteTerm(e.target.value)}
                                        className="w-full rounded-md border-gray-300 shadow-sm p-2 pl-10 border"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Fecha Desde</label>
                                    <input 
                                        type="date"
                                        value={fechaDesde}
                                        onChange={e => setFechaDesde(e.target.value)}
                                        className="w-full rounded-md border-gray-300 shadow-sm p-2 border"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Fecha Hasta</label>
                                    <input 
                                        type="date"
                                        value={fechaHasta}
                                        onChange={e => setFechaHasta(e.target.value)}
                                        className="w-full rounded-md border-gray-300 shadow-sm p-2 border"
                                    />
                                </div>
                            </div>
                            <div className="flex justify-end">
                                <button onClick={clearFilters} className="text-sm text-gray-600 hover:text-gray-900 font-semibold flex items-center">
                                    <i className="fas fa-times-circle mr-1"></i>Limpiar Filtros
                                </button>
                            </div>
                        </div>

                        <div className="flex flex-col sm:flex-row justify-between items-center mb-4">
                            <p className="text-gray-600 font-semibold">
                                {filteredData.length} registro(s) encontrado(s)
                            </p>
                            <div className="flex space-x-2 mt-4 sm:mt-0">
                                <button 
                                    onClick={fetchData}
                                    disabled={isLoading}
                                    className="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 disabled:opacity-50 flex items-center"
                                >
                                    <i className={`fas fa-sync-alt ${isLoading ? 'animate-spin' : ''} mr-2`}></i>
                                    Refrescar
                                </button>
                                <div className="relative" ref={exportMenuRef}>
                                    <button 
                                        onClick={() => setIsExportOpen(prev => !prev)}
                                        disabled={filteredData.length === 0}
                                        className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 disabled:opacity-50 flex items-center"
                                    >
                                        <i className="fas fa-download mr-2"></i>
                                        Exportar
                                        <i className={`fas fa-chevron-down ml-2 transition-transform ${isExportOpen ? 'rotate-180' : ''}`}></i>
                                    </button>
                                    {isExportOpen && (
                                        <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border z-20">
                                            <ul className="text-gray-700">
                                                <li><button onClick={exportToPDF} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-file-pdf w-6 mr-2 text-red-500"></i>Exportar a PDF</button></li>
                                                <li><button onClick={exportToExcel} className="w-full text-left hover:bg-gray-100 p-3 flex items-center"><i className="fas fa-file-excel w-6 mr-2 text-green-500"></i>Exportar a Excel</button></li>
                                            </ul>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="overflow-x-auto rounded-lg shadow-md border">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-800 text-white">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">SKU</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Descripción</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Nº Pallet</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Lotes Prod.</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">F. Prod.</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Cantidad</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">U.M.</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {isLoading ? (
                                        <tr><td colSpan="7" className="p-8 text-center text-gray-500">Cargando datos...</td></tr>
                                    ) : (
                                        filteredData.length > 0 ? filteredData.map((item, index) => (
                                            <tr key={item.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                <td className="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{item.sku}</td>
                                                <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-600">{item.descripcion}</td>
                                                <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-600">{item.numeroDePallet}</td>
                                                <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-600">{item.lotesProduccion}</td>
                                                <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-600">{item.fechaProduccion}</td>
                                                <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-600">{item.cantidad}</td>
                                                <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-600">{item.unidadMedida}</td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan="7" className="px-4 py-8 text-center text-sm text-gray-500">No se encontraron registros con los filtros aplicados.</td>
                                            </tr>
                                        )
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
