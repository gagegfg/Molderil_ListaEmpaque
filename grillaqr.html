<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLDERIL - Grilla de Pallets (v2.1 - Cabecera Fija)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .menu-dots {
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        .menu-dots:hover {
            background-color: #f0f0f0;
        }
        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
            width: 160px;
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        .dropdown-item:hover {
            background-color: #f5f5f5;
        }
        .dropdown-item svg {
            margin-right: 10px;
            color: #555;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 600px;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // =================================================================
        // ### CONFIGURACIÓN: DATOS DEL REPOSITORIO ###
        // =================================================================
        const USUARIO_GITHUB = 'gagegfg';
        const REPO_NOMBRE = 'Molderil_ListaEmpaque';
        const RUTA_HISTORICO_CSV = 'detallelotes.csv';
        const RUTA_NOTAS_CSV = 'notasskulote.csv';
        // =================================================================
        
        const ObservationModal = ({ text, onClose }) => {
            if (!text) return null;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <button className="modal-close-btn" onClick={onClose}>&times;</button>
                        <h3 className="text-2xl font-bold text-gray-800 mb-4">Observación del Pallet</h3>
                        <p className="text-gray-700 whitespace-pre-wrap text-base">{text}</p>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [allLotes, setAllLotes] = useState([]);
            const [filteredLotes, setFilteredLotes] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [apiToken, setApiToken] = useState(null);
            const [activeMenu, setActiveMenu] = useState(null);
            const menuRef = useRef(null);
            const [modalData, setModalData] = useState({ visible: false, text: '' });
            
            const getInitialDates = () => {
                const hasta = new Date();
                const desde = new Date(hasta.getFullYear(), hasta.getMonth() - 1, 1);
                return {
                    fechaDesde: desde.toISOString().split('T')[0],
                    fechaHasta: hasta.toISOString().split('T')[0]
                };
            };
            
            const [fechaDesde, setFechaDesde] = useState(getInitialDates().fechaDesde);
            const [fechaHasta, setFechaHasta] = useState(getInitialDates().fechaHasta);
            const [showDespachados, setShowDespachados] = useState(true);

            useEffect(() => {
                const fetchTokenAndData = async () => {
                    setIsLoading(true);
                    setError(null);
                    let token = null;
                    try {
                        const tokenResponse = await fetch('cls.txt', { cache: 'no-store' });
                        if (!tokenResponse.ok) throw new Error('No se pudo cargar el token de API.');
                        let rawToken = await tokenResponse.text();
                        token = rawToken.replace(/aaaa/g, '').replace(/bbbb/g, '').replace(/cccc/g, '').trim();
                        setApiToken(token);
                    } catch (err) {
                        setError('Error crítico: No se pudo cargar la clave de API. La funcionalidad de borrado estará deshabilitada.');
                        console.error(err);
                    }
                    
                    try {
                        const urlHistorico = `https://raw.githubusercontent.com/${USUARIO_GITHUB}/${REPO_NOMBRE}/main/${RUTA_HISTORICO_CSV}`;
                        const urlNotas = `https://raw.githubusercontent.com/${USUARIO_GITHUB}/${REPO_NOMBRE}/main/${RUTA_NOTAS_CSV}`;
                        
                        const [historicoRes, notasRes] = await Promise.all([
                            fetch(urlHistorico, { cache: 'no-store' }),
                            fetch(urlNotas, { cache: 'no-store' })
                        ]);

                        if (!historicoRes.ok) throw new Error('No se pudo cargar el historial de lotes.');
                        
                        const historicoText = await historicoRes.text();
                        
                        const notasMap = new Map();
                        if (notasRes.ok) {
                            const notasText = await notasRes.text();
                            const notasRows = notasText.split('\n').filter(Boolean);
                            notasRows.forEach(row => {
                                const parts = row.split(';');
                                if (parts.length >= 3) {
                                    const key = `${parts[0]};${parts[1]}`;
                                    notasMap.set(key, parts[2]);
                                }
                            });
                        }

                        const parsedLotes = historicoText.split('\n')
                            .filter(line => line.trim() !== '')
                            .map(line => {
                                const parts = line.split(';');
                                const lote = {
                                    sku: parts[0],
                                    descripcion: parts[1],
                                    pallet: parts[2],
                                    lotes: parts[3]?.replace(/#/g, ' / '),
                                    fecha: parts[4],
                                    cantidad: parts[5]?.replace('.', ','),
                                    uom: parts[6],
                                    estado: parts[7] || 'PENDIENTE',
                                    cliente: parts[8] || ''
                                };
                                const notaKey = `${lote.sku};${lote.pallet}`;
                                if (notasMap.has(notaKey)) {
                                    lote.observacion = notasMap.get(notaKey);
                                }
                                return lote;
                            }).reverse();
                        
                        setAllLotes(parsedLotes);
                        
                        const { fechaDesde: initialDesde, fechaHasta: initialHasta } = getInitialDates();
                        const initialFiltered = parsedLotes.filter(lote => {
                            const fechaLote = new Date(lote.fecha.split('/').reverse().join('-') + 'T00:00:00');
                            const desde = new Date(initialDesde + 'T00:00:00');
                            const hasta = new Date(initialHasta + 'T23:59:59');
                            return fechaLote >= desde && fechaLote <= hasta;
                        });
                        setFilteredLotes(initialFiltered);
                        
                    } catch (err) {
                        setError(err.message);
                        console.error(err);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchTokenAndData();
            }, []);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setActiveMenu(null);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);
            
            const handleFilter = () => {
                let tempLotes = [...allLotes];
                
                const desde = new Date(fechaDesde + 'T00:00:00');
                const hasta = new Date(fechaHasta + 'T23:59:59');
                tempLotes = tempLotes.filter(lote => {
                    const fechaLote = new Date(lote.fecha.split('/').reverse().join('-') + 'T00:00:00');
                    return fechaLote >= desde && fechaLote <= hasta;
                });
                
                if (searchTerm) {
                    tempLotes = tempLotes.filter(lote => 
                        lote.sku.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        lote.descripcion.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        lote.pallet.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }

                if (!showDespachados) {
                    tempLotes = tempLotes.filter(lote => lote.estado.toUpperCase() !== 'TRUE');
                }
                
                setFilteredLotes(tempLotes);
            };
            
            const deleteNoteFromFile = async (sku, pallet) => {
                if (!apiToken) {
                    alert('Error: Token de API no disponible. No se puede borrar la nota.');
                    return false;
                }
                const url = `https://api.github.com/repos/${USUARIO_GITHUB}/${REPO_NOMBRE}/contents/${RUTA_NOTAS_CSV}`;
                try {
                    const fileResponse = await fetch(url, { headers: { 'Authorization': `token ${apiToken}` } });
                    if (!fileResponse.ok) {
                        if (fileResponse.status === 404) {
                            console.log('El archivo de notas no existe, no hay nada que borrar.');
                            return true;
                        }
                        throw new Error(`Error ${fileResponse.status}: No se pudo obtener info del archivo de notas.`);
                    }
                    const fileData = await fileResponse.json();
                    
                    const lines = atob(fileData.content).split('\n');
                    const updatedLines = lines.filter(line => {
                        const parts = line.split(';');
                        return !(parts[0] === sku && parts[1] === pallet);
                    });
                    
                    const newContent = updatedLines.join('\n');

                    const putResponse = await fetch(url, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${apiToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: `Eliminando nota para pallet ${pallet}`,
                            content: btoa(newContent),
                            sha: fileData.sha,
                        }),
                    });

                    if (!putResponse.ok) throw new Error(`Error ${putResponse.status} al actualizar el archivo de notas.`);
                    console.log('Nota eliminada correctamente.');
                    return true;
                } catch (error) {
                    console.error('Error en deleteNoteFromFile:', error);
                    alert(`ERROR: No se pudo eliminar la nota asociada.\n${error.message}`);
                    return false;
                }
            };
            
            const handleDelete = async (loteToDelete) => {
                if (!apiToken) {
                    alert('Error: Token de API no disponible.');
                    return;
                }
                const isConfirmed = window.confirm(`¿Está seguro que desea marcar como eliminado el Pallet Nº ${loteToDelete.pallet}? Esta acción no se puede deshacer.`);
                if (isConfirmed) {
                    try {
                        const url = `https://api.github.com/repos/${USUARIO_GITHUB}/${REPO_NOMBRE}/contents/${RUTA_HISTORICO_CSV}`;
                        const fileResponse = await fetch(url, { headers: { 'Authorization': `token ${apiToken}` } });
                        if (!fileResponse.ok) throw new Error(`Error ${fileResponse.status} al obtener el historial.`);
                        
                        const fileData = await fileResponse.json();
                        const lines = atob(fileData.content).split('\n');
                        let found = false;
                        
                        const updatedLines = lines.map(line => {
                            const parts = line.split(';');
                            if (parts[2] === loteToDelete.pallet) {
                                found = true;
                                parts[7] = 'DELETED';
                                return parts.join(';');
                            }
                            return line;
                        });

                        if (!found) throw new Error('No se encontró el pallet en el archivo.');

                        const newContent = updatedLines.join('\n');
                        const putResponse = await fetch(url, {
                            method: 'PUT',
                            headers: { 'Authorization': `token ${apiToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: `Marcando pallet ${loteToDelete.pallet} como DELETED`,
                                content: btoa(newContent),
                                sha: fileData.sha,
                            }),
                        });

                        if (!putResponse.ok) throw new Error(`Error ${putResponse.status} al guardar el historial.`);
                        
                        alert(`Pallet Nº ${loteToDelete.pallet} marcado como eliminado.`);

                        if (loteToDelete.observacion) {
                            console.log("Este pallet tiene una nota, procediendo a borrarla...");
                            await deleteNoteFromFile(loteToDelete.sku, loteToDelete.pallet);
                        }

                        const updatedLotes = allLotes.map(l => l.pallet === loteToDelete.pallet ? { ...l, estado: 'DELETED' } : l);
                        setAllLotes(updatedLotes);
                        handleFilter();

                    } catch (error) {
                        console.error('Error al eliminar:', error);
                        alert(`No se pudo completar la eliminación: ${error.message}`);
                    }
                }
                setActiveMenu(null);
            };

            const renderStatus = (estado) => {
                if (estado?.toUpperCase() === 'TRUE') return <span className="px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">Despachado</span>;
                if (estado?.toUpperCase() === 'DELETED') return <span className="px-2 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full">Eliminado</span>;
                return <span className="px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full">Pendiente</span>;
            };

            if (isLoading) return <div className="p-8 text-center text-gray-600">Cargando registros...</div>;
            if (error && !allLotes.length) return <div className="p-8 text-center text-red-600">Error: {error}</div>;

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    <ObservationModal 
                        text={modalData.text} 
                        onClose={() => setModalData({ visible: false, text: '' })} 
                    />
                    
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-extrabold text-gray-900">Historial de Pallets</h1>
                            <a href="generarqr.html" className="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center">+ Generar Nuevo</a>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <input 
                                type="text" 
                                placeholder="Buscar SKU, Descripción, Pallet..."
                                className="col-span-1 md:col-span-2 p-2 border rounded-md"
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                            />
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Desde</label>
                                <input 
                                    type="date" 
                                    className="p-2 border rounded-md w-full"
                                    value={fechaDesde}
                                    onChange={e => setFechaDesde(e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Hasta</label>
                                <input 
                                    type="date" 
                                    className="p-2 border rounded-md w-full"
                                    value={fechaHasta}
                                    onChange={e => setFechaHasta(e.target.value)}
                                />
                            </div>
                        </div>
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center">
                                <input 
                                    type="checkbox" 
                                    id="showDespachados" 
                                    className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                    checked={showDespachados}
                                    onChange={e => setShowDespachados(e.target.checked)}
                                />
                                <label htmlFor="showDespachados" className="ml-2 block text-sm text-gray-900">Mostrar despachados</label>
                            </div>
                            <button onClick={handleFilter} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">
                                Refrescar
                            </button>
                        </div>
                        
                        <div className="overflow-x-auto">
                            <table className="min-w-full bg-white">
                                {/* --- MODIFICADO ---: Se añadieron clases para hacer la cabecera fija y pegajosa */}
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="sticky top-0 bg-gray-50 py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                        <th className="sticky top-0 bg-gray-50 py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                        <th className="sticky top-0 bg-gray-50 py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nº de Pallet</th>
                                        <th className="sticky top-0 bg-gray-50 py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Prod.</th>
                                        <th className="sticky top-0 bg-gray-50 py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                        <th className="sticky top-0 bg-gray-50 py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                        <th className="sticky top-0 bg-gray-50 py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredLotes.length > 0 ? filteredLotes.map(lote => (
                                        <tr 
                                            key={lote.pallet} 
                                            className={lote.observacion ? 'bg-yellow-100 hover:bg-yellow-200 cursor-pointer' : 'hover:bg-gray-50'}
                                            onDoubleClick={() => lote.observacion && setModalData({ visible: true, text: lote.observacion })}
                                        >
                                            <td className="py-4 px-4 whitespace-nowrap text-sm font-medium text-gray-900">{lote.sku}</td>
                                            <td className="py-4 px-4 whitespace-nowrap text-sm text-gray-500">{lote.descripcion}</td>
                                            <td className="py-4 px-4 whitespace-nowrap text-sm text-gray-500">
                                                {lote.pallet}
                                                {lote.observacion && <span className="text-red-500 font-bold ml-1">(*)</span>}
                                            </td>
                                            <td className="py-4 px-4 whitespace-nowrap text-sm text-gray-500">{lote.fecha}</td>
                                            <td className="py-4 px-4 whitespace-nowrap text-sm text-gray-500">{lote.cantidad} {lote.uom}</td>
                                            <td className="py-4 px-4 whitespace-nowrap text-sm">{renderStatus(lote.estado)}</td>
                                            <td className="py-4 px-4 whitespace-nowrap text-sm font-medium relative">
                                                <div className="menu-dots" onClick={() => setActiveMenu(lote.pallet === activeMenu ? null : lote.pallet)}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" /></svg>
                                                </div>
                                                {activeMenu === lote.pallet && (
                                                    <div className="dropdown-menu" ref={menuRef}>
                                                        <div className="dropdown-item" onClick={() => handleDelete(lote)}>
                                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                            Eliminar
                                                        </div>
                                                    </div>
                                                )}
                                            </td>
                                        </tr>
                                    )) : (
                                        <tr>
                                            <td colSpan="7" className="text-center py-8 text-gray-500">No se encontraron registros para los filtros seleccionados.</td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
